<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DHL Courier PROD</title>
  <style>
    /* RESET FOR ANDROID 2.3 */
    * { -webkit-tap-highlight-color: transparent; }
    html, body { 
      margin: 0; 
      padding: 0; 
      width: 100%;
      height: 100%;
      background: #000;
      font-family: Arial, sans-serif;
      font-size: 14px;
      overflow: hidden;
      color: #FFF;
    }
    
    /* 480x800 SPECIFIC LAYOUT */
    .screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 480px;
      height: 800px;
      background: #000;
      display: none;
      z-index: 100;
    }
    
    .screen.active {
      display: block;
    }
    
    /* HEADER - 60px */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      width: 480px;
      height: 60px;
      background: #FFCC00;
      color: #000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 101;
    }
    
    .header-time {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .header-title {
      position: absolute;
      top: 30px;
      left: 10px;
      right: 10px;
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .header-status {
      position: absolute;
      top: 8px;
      right: 10px;
      font-size: 12px;
      text-align: right;
    }
    
    /* CONTENT AREA */
    .content {
      position: absolute;
      top: 60px;
      left: 0;
      width: 480px;
      height: 690px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      background: #222;
    }
    
    /* FOOTER - 50px */
    .footer {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 480px;
      height: 50px;
      background: #333;
      border-top: 2px solid #FFCC00;
      z-index: 101;
    }
    
    .footer-left {
      position: absolute;
      left: 10px;
      top: 15px;
    }
    
    .footer-right {
      position: absolute;
      right: 10px;
      top: 15px;
    }
    
    /* HOME MENU */
    .home-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 15px;
      padding: 20px;
    }
    
    .home-btn {
      height: 150px;
      background: #333;
      border: 2px solid #555;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      cursor: pointer;
    }
    
    .home-btn-icon {
      font-size: 40px;
      margin-bottom: 10px;
      color: #FFCC00;
    }
    
    .home-btn-text {
      font-size: 16px;
      font-weight: bold;
    }
    
    /* LIST STYLES */
    .list-container {
      padding: 10px;
    }
    
    .list-item {
      background: #333;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    
    .list-item-title {
      font-size: 16px;
      font-weight: bold;
      color: #FFCC00;
      margin-bottom: 5px;
    }
    
    .list-item-sub {
      font-size: 12px;
      color: #CCC;
    }
    
    /* SCAN SCREEN */
    .scan-area {
      position: relative;
      width: 440px;
      height: 440px;
      margin: 20px;
      border: 3px solid #FFCC00;
      border-radius: 5px;
      overflow: hidden;
      background: #000;
    }
    
    #camera-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .scan-crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200px;
      height: 100px;
      transform: translate(-50%, -50%);
      border: 2px dashed #FFCC00;
    }
    
    .scan-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 20px;
    }
    
    /* BUTTONS */
    .btn {
      background: #444;
      border: 2px solid #666;
      border-radius: 5px;
      color: white;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      min-width: 100px;
      text-align: center;
    }
    
    .btn-primary {
      background: #FFCC00;
      border-color: #FF9900;
      color: #000;
      font-weight: bold;
    }
    
    .btn-danger {
      background: #CC0000;
      border-color: #990000;
    }
    
    /* STOP DETAIL */
    .stop-info {
      background: #333;
      border-radius: 8px;
      padding: 15px;
      margin: 15px;
      border: 2px solid #555;
    }
    
    .stop-info-row {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #555;
    }
    
    .stop-info-row:last-child {
      border-bottom: none;
    }
    
    .stop-actions {
      padding: 15px;
    }
    
    .stop-action-btn {
      width: 100%;
      margin-bottom: 10px;
      height: 50px;
    }
    
    /* SIGNATURE */
    .signature-area {
      width: 440px;
      height: 440px;
      margin: 20px;
      background: white;
      border: 2px solid #666;
      border-radius: 5px;
    }
    
    #signature-canvas {
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }
    
    /* LOADING */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #333;
      border-top: 5px solid #FFCC00;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* STATUS BADGES */
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .status-pending { background: #FF9900; color: #000; }
    .status-delivered { background: #00CC00; color: #000; }
    .status-exception { background: #CC0000; color: #FFF; }
    
    /* MESSAGES */
    .message-item {
      background: #333;
      border-left: 4px solid #FFCC00;
      margin-bottom: 10px;
      padding: 10px;
    }
    
    .message-unread {
      border-left-color: #00CC00;
      background: #2A2A2A;
    }
    
    /* SCAN RESULT */
    .scan-result {
      text-align: center;
      padding: 10px;
      font-size: 18px;
      font-weight: bold;
      margin: 10px;
      border-radius: 5px;
      background: #333;
    }
    
    .scan-success { color: #00CC00; }
    .scan-error { color: #CC0000; }
    .scan-warning { color: #FFCC00; }
    
    /* UTILITIES */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-10 { margin-top: 10px; }
    .mb-10 { margin-bottom: 10px; }
    .p-10 { padding: 10px; }
    .bold { font-weight: bold; }
    
    /* ANDROID 2.3 FIXES */
    input, textarea, select {
      font-size: 16px; /* Prevents zoom on Android */
      background: #222;
      color: white;
      border: 1px solid #555;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    
    select {
      height: 40px;
    }
    
    /* FORCE 480px VIEWPORT */
    @media (max-width: 480px) {
      .screen { width: 480px; }
      .header { width: 480px; }
      .content { width: 480px; }
      .footer { width: 480px; }
    }
  </style>
</head>
<body>
  <!-- LOADING SCREEN -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
  </div>

  <!-- HOME SCREEN -->
  <div id="screen-home" class="screen active">
    <div class="header">
      <div class="header-time" id="current-time">--:--</div>
      <div class="header-title">DHL Courier PROD</div>
      <div class="header-status">
        <span id="sync-status">OFFLINE</span>
        <div id="sync-indicator" style="display:inline-block;width:10px;height:10px;background:#CC0000;border-radius:50%;margin-left:5px;"></div>
      </div>
    </div>
    
    <div class="content">
      <div class="home-grid">
        <div class="home-btn" onclick="goToScreen('scan')">
          <div class="home-btn-icon">üì¶</div>
          <div class="home-btn-text">SCAN</div>
        </div>
        
        <div class="home-btn" onclick="loadDeliveries()">
          <div class="home-btn-icon">üöö</div>
          <div class="home-btn-text">DELIVERIES</div>
        </div>
        
        <div class="home-btn" onclick="loadPickups()">
          <div class="home-btn-icon">‚¨ÜÔ∏è</div>
          <div class="home-btn-text">PICKUPS</div>
        </div>
        
        <div class="home-btn" onclick="loadMessages()">
          <div class="home-btn-icon">‚úâÔ∏è</div>
          <div class="home-btn-text">MESSAGES</div>
        </div>
        
        <div class="home-btn" onclick="goToScreen('settings')">
          <div class="home-btn-icon">‚öôÔ∏è</div>
          <div class="home-btn-text">SETTINGS</div>
        </div>
        
        <div class="home-btn" onclick="syncAllData()">
          <div class="home-btn-icon">üîÑ</div>
          <div class="home-btn-text">SYNC</div>
        </div>
      </div>
      
      <div style="padding:20px;text-align:center;">
        <div style="margin-bottom:10px;">Courier: <span id="courier-id-display" class="bold">NOT SET</span></div>
        <div>Stops Today: <span id="today-stops" class="bold">0</span></div>
        <div>Delivered: <span id="delivered-count" class="bold">0</span></div>
      </div>
    </div>
    
    <div class="footer">
      <div class="footer-left">
        <button class="btn" onclick="showDebug()">Debug</button>
      </div>
      <div class="footer-right">
        <span id="device-info">CS400</span>
      </div>
    </div>
  </div>

  <!-- SCAN SCREEN -->
  <div id="screen-scan" class="screen">
    <div class="header">
      <div class="header-time" id="scan-time">--:--</div>
      <div class="header-title">Scan Package</div>
      <div class="header-status">
        <button class="btn" style="padding:2px 8px;font-size:12px;" onclick="toggleFlash()">üí°</button>
      </div>
    </div>
    
    <div class="content">
      <div class="scan-area">
        <video id="camera-preview" autoplay playsinline></video>
        <div class="scan-crosshair"></div>
      </div>
      
      <div class="scan-result" id="scan-result">
        Ready to scan
      </div>
      
      <div class="scan-buttons">
        <button class="btn" onclick="startManualScan()">Manual Entry</button>
        <button class="btn" onclick="toggleCamera()">Switch Cam</button>
        <button class="btn btn-primary" onclick="captureAndScan()">SCAN NOW</button>
      </div>
      
      <div style="padding:20px;text-align:center;">
        <input type="text" id="manual-barcode" placeholder="Enter barcode manually" style="width:300px;margin-bottom:10px;" class="hidden">
        <div>
          <button class="btn" onclick="useMockBarcode()" style="font-size:12px;">Test Scan</button>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <div class="footer-left">
        <button class="btn" onclick="goToScreen('home')">‚Üê Home</button>
      </div>
      <div class="footer-right">
        Last: <span id="last-scan">None</span>
      </div>
    </div>
  </div>

  <!-- DELIVERIES SCREEN -->
  <div id="screen-deliveries" class="screen">
    <div class="header">
      <div class="header-time" id="deliveries-time">--:--</div>
      <div class="header-title">Deliveries</div>
      <div class="header-status">
        <span id="route-progress">0/0</span>
      </div>
    </div>
    
    <div class="content">
      <div id="deliveries-list" class="list-container">
        <!-- Loaded dynamically -->
      </div>
    </div>
    
    <div class="footer">
      <div class="footer-left">
        <button class="btn" onclick="goToScreen('home')">‚Üê Home</button>
      </div>
      <div class="footer-right">
        <span id="total-deliveries">0 stops</span>
      </div>
    </div>
  </div>

  <!-- STOP DETAIL SCREEN -->
  <div id="screen-stop" class="screen">
    <div class="header">
      <div class="header-time" id="stop-time">--:--</div>
      <div class="header-title" id="stop-title">Stop Details</div>
      <div class="header-status">
        Stop <span id="stop-number">0</span>/<span id="total-stops">0</span>
      </div>
    </div>
    
    <div class="content">
      <div id="stop-details" class="stop-info">
        <!-- Loaded dynamically -->
      </div>
      
      <div class="stop-actions">
        <button class="btn btn-primary stop-action-btn" onclick="goToScreen('scan')">üì¶ Scan Package</button>
        <button class="btn stop-action-btn" onclick="goToScreen('signature')">‚úçÔ∏è Get Signature</button>
        <button class="btn stop-action-btn" onclick="takePhotoProof()">üì∏ Photo Proof</button>
        <button class="btn stop-action-btn" onclick="markException()">‚ö†Ô∏è Mark Exception</button>
        <button class="btn btn-danger stop-action-btn" onclick="markAsDelivered()">‚úÖ Mark Delivered</button>
      </div>
    </div>
    
    <div class="footer">
      <div class="footer-left">
        <button class="btn" onclick="goToScreen('deliveries')">‚Üê Back</button>
      </div>
      <div class="footer-right">
        ID: <span id="stop-id">---</span>
      </div>
    </div>
  </div>

  <!-- SIGNATURE SCREEN -->
  <div id="screen-signature" class="screen">
    <div class="header">
      <div class="header-time" id="signature-time">--:--</div>
      <div class="header-title">Signature</div>
      <div class="header-status">POD</div>
    </div>
    
    <div class="content">
      <div class="signature-area">
        <canvas id="signature-canvas" width="440" height="440"></canvas>
      </div>
      
      <div class="scan-buttons">
        <button class="btn" onclick="clearSignature()">Clear</button>
        <button class="btn btn-primary" onclick="saveSignature()">Save Signature</button>
      </div>
    </div>
    
    <div class="footer">
      <div class="footer-left">
        <button class="btn" onclick="goToScreen('stop')">‚Üê Back</button>
      </div>
      <div class="footer-right">
        Required
      </div>
    </div>
  </div>

  <!-- SETTINGS SCREEN -->
  <div id="screen-settings" class="screen">
    <div class="header">
      <div class="header-time" id="settings-time">--:--</div>
      <div class="header-title">Settings</div>
      <div class="header-status">v1.0</div>
    </div>
    
    <div class="content">
      <div class="stop-info">
        <div class="stop-info-row">
          <div class="bold">Courier ID</div>
          <input type="text" id="courier-id-input" placeholder="Enter your Courier ID">
          <button class="btn btn-primary mt-10" onclick="saveCourierId()">Save ID</button>
        </div>
        
        <div class="stop-info-row">
          <div class="bold">AppScript URL</div>
          <input type="text" id="appscript-url" placeholder="https://script.google.com/...">
          <button class="btn mt-10" onclick="testConnection()">Test Connection</button>
        </div>
        
        <div class="stop-info-row">
          <div class="bold">Offline Data</div>
          <div>Pending uploads: <span id="pending-count">0</span></div>
          <button class="btn mt-10" onclick="forceSync()">Force Sync Now</button>
        </div>
        
        <div class="stop-info-row">
          <div class="bold">Device Info</div>
          <div>Screen: 480x800</div>
          <div>Android: 2.3.3</div>
          <div>App Version: 1.0.0</div>
        </div>
      </div>
      
      <div class="stop-actions">
        <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
        <button class="btn" onclick="exportData()">Export Data</button>
        <button class="btn" onclick="showLogs()">View Logs</button>
      </div>
    </div>
    
    <div class="footer">
      <div class="footer-left">
        <button class="btn" onclick="goToScreen('home')">‚Üê Home</button>
      </div>
      <div class="footer-right">
        <span id="connection-status">Disconnected</span>
      </div>
    </div>
  </div>

  <!-- MESSAGES SCREEN -->
  <div id="screen-messages" class="screen">
    <div class="header">
      <div class="header-time" id="messages-time">--:--</div>
      <div class="header-title">Messages</div>
      <div class="header-status">
        <span id="unread-count">0</span> unread
      </div>
    </div>
    
    <div class="content">
      <div id="messages-list" class="list-container">
        <!-- Loaded dynamically -->
      </div>
    </div>
    
    <div class="footer">
      <div class="footer-left">
        <button class="btn" onclick="goToScreen('home')">‚Üê Home</button>
      </div>
      <div class="footer-right">
        <button class="btn" onclick="refreshMessages()">Refresh</button>
      </div>
    </div>
  </div>

  <!-- HIDDEN DATA -->
  <input type="hidden" id="current-stop-id" value="">
  <input type="hidden" id="current-signature" value="">
  <input type="hidden" id="current-photo" value="">

  <script>
    // =============================================
    // CONFIGURATION - REPLACE WITH YOUR VALUES
    // =============================================
    const CONFIG = {
      // ***** REPLACE THIS WITH YOUR APPSCRIPT URL *****
      APPSCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzy7veCW1Ug5QENnUaUgGH9QYybtvGhxKXzbPEG7h3kqUGcS6JFEc8N_ZwqCgphH-WWWg/exec',
      
      // App settings
      VERSION: '1.0.0',
      DEVICE_ID: 'CS400',
      SHEET_ID: '1jO-wWgKMQqIiKBateHXcb04DGu68YVhjBIfM49cDRCs'
    };

    // =============================================
    // GLOBAL STATE
    // =============================================
    let APP_STATE = {
      courierId: '',
      deliveries: [],
      currentStop: null,
      messages: [],
      pickups: [],
      offlineData: [],
      cameraActive: false,
      currentCamera: 'environment',
      lastScan: '',
      connectionStatus: 'offline',
      logs: []
    };

    // =============================================
    // INITIALIZATION
    // =============================================
    document.addEventListener('DOMContentLoaded', function() {
      log('App starting for Android 2.3.3 (480x800)');
      
      // Load saved settings
      loadSettings();
      
      // Initialize components
      initTime();
      initSignature();
      initCamera();
      
      // Hide loading screen
      setTimeout(() => {
        document.getElementById('loading').classList.add('hidden');
      }, 1000);
      
      // Start background processes
      setInterval(updateTime, 1000);
      setInterval(checkConnection, 30000);
      setInterval(syncOfflineData, 60000);
      
      // Initial data load
      setTimeout(loadInitialData, 1500);
    });

    // =============================================
    // NAVIGATION
    // =============================================
    function goToScreen(screenName) {
      log(`Navigating to: ${screenName}`);
      
      // Hide all screens
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      
      // Show target screen
      const targetScreen = document.getElementById(`screen-${screenName}`);
      if (targetScreen) {
        targetScreen.classList.add('active');
        updateScreenTime(screenName);
        
        // Special handling for each screen
        switch(screenName) {
          case 'home':
            updateHomeStats();
            break;
          case 'deliveries':
            renderDeliveriesList();
            break;
          case 'messages':
            renderMessagesList();
            break;
          case 'scan':
            startCamera();
            break;
        }
      }
    }

    // =============================================
    // TIME MANAGEMENT
    // =============================================
    function initTime() {
      updateTime();
    }

    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const dateStr = now.toLocaleDateString();
      
      // Update all time displays
      document.querySelectorAll('[id$="-time"]').forEach(el => {
        el.textContent = timeStr;
      });
    }

    function updateScreenTime(screen) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const timeEl = document.getElementById(`${screen}-time`);
      if (timeEl) timeEl.textContent = timeStr;
    }

    // =============================================
    // SETTINGS MANAGEMENT
    // =============================================
    function loadSettings() {
      // Load from localStorage
      APP_STATE.courierId = localStorage.getItem('courier_id') || '';
      const savedUrl = localStorage.getItem('appscript_url') || CONFIG.APPSCRIPT_URL;
      
      // Update UI
      document.getElementById('courier-id-display').textContent = APP_STATE.courierId || 'NOT SET';
      document.getElementById('courier-id-input').value = APP_STATE.courierId;
      document.getElementById('appscript-url').value = savedUrl;
      
      // Update config
      CONFIG.APPSCRIPT_URL = savedUrl;
      
      log('Settings loaded');
    }

    function saveCourierId() {
      const newId = document.getElementById('courier-id-input').value.trim();
      if (!newId) {
        alert('Please enter a Courier ID');
        return;
      }
      
      APP_STATE.courierId = newId;
      localStorage.setItem('courier_id', newId);
      document.getElementById('courier-id-display').textContent = newId;
      
      alert('Courier ID saved!');
      log(`Courier ID set to: ${newId}`);
    }

    function saveAppScriptUrl() {
      const newUrl = document.getElementById('appscript-url').value.trim();
      if (!newUrl || !newUrl.includes('script.google.com')) {
        alert('Please enter a valid AppScript URL');
        return;
      }
      
      CONFIG.APPSCRIPT_URL = newUrl;
      localStorage.setItem('appscript_url', newUrl);
      
      alert('AppScript URL saved!');
      log(`AppScript URL updated`);
    }

    // =============================================
    // DATA LOADING
    // =============================================
    async function loadInitialData() {
      log('Loading initial data...');
      
      if (!APP_STATE.courierId) {
        alert('Please set your Courier ID in Settings first!');
        goToScreen('settings');
        return;
      }
      
      showLoading();
      
      try {
        // Load deliveries
        await loadDeliveries();
        
        // Load messages
        await loadMessages();
        
        // Load pickups
        await loadPickups();
        
        // Update stats
        updateHomeStats();
        
        // Check connection
        await checkConnection();
        
        log('Initial data loaded successfully');
      } catch (error) {
        log(`Data load error: ${error.message}`);
        alert('Using offline data. Check connection.');
      } finally {
        hideLoading();
      }
    }

    async function loadDeliveries() {
      log('Loading deliveries...');
      
      try {
        // Try to fetch from AppScript
        const response = await appScriptRequest('GET', {
          action: 'getDeliveries',
          courierId: APP_STATE.courierId
        });
        
        if (response && response.success) {
          APP_STATE.deliveries = response.data || [];
          log(`Loaded ${APP_STATE.deliveries.length} deliveries from server`);
        } else {
          // Fallback to mock data
          APP_STATE.deliveries = getMockDeliveries();
          log(`Using mock data: ${APP_STATE.deliveries.length} deliveries`);
        }
        
        renderDeliveriesList();
        
      } catch (error) {
        log(`Delivery load error: ${error.message}`);
        APP_STATE.deliveries = getMockDeliveries();
        renderDeliveriesList();
      }
    }

    async function loadMessages() {
      log('Loading messages...');
      
      try {
        const response = await appScriptRequest('GET', {
          action: 'getMessages',
          courierId: APP_STATE.courierId
        });
        
        if (response && response.success) {
          APP_STATE.messages = response.data || [];
        } else {
          APP_STATE.messages = getMockMessages();
        }
        
        renderMessagesList();
        
      } catch (error) {
        log(`Message load error: ${error.message}`);
        APP_STATE.messages = getMockMessages();
        renderMessagesList();
      }
    }

    async function loadPickups() {
      // Similar to loadDeliveries
      APP_STATE.pickups = getMockPickups();
    }

    // =============================================
    // RENDER FUNCTIONS
    // =============================================
    function renderDeliveriesList() {
      const container = document.getElementById('deliveries-list');
      if (!container) return;
      
      if (!APP_STATE.deliveries.length) {
        container.innerHTML = '<div class="text-center p-10">No deliveries scheduled</div>';
        return;
      }
      
      let html = '';
      APP_STATE.deliveries.forEach((stop, index) => {
        const statusClass = `status-${stop.status || 'pending'}`;
        
        html += `
          <div class="list-item" onclick="openStop('${stop.id}')">
            <div class="list-item-title">
              <span class="status-badge ${statusClass}">${stop.status || 'PENDING'}</span>
              ${stop.customer_name || `Stop ${index + 1}`}
            </div>
            <div class="list-item-sub">${stop.address || 'No address'}</div>
            <div class="list-item-sub">${stop.packages || 1} package(s)</div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      
      // Update counters
      const total = APP_STATE.deliveries.length;
      const delivered = APP_STATE.deliveries.filter(s => s.status === 'delivered').length;
      
      document.getElementById('total-deliveries').textContent = `${total} stops`;
      document.getElementById('route-progress').textContent = `${delivered}/${total}`;
    }

    function renderMessagesList() {
      const container = document.getElementById('messages-list');
      if (!container) return;
      
      if (!APP_STATE.messages.length) {
        container.innerHTML = '<div class="text-center p-10">No messages</div>';
        return;
      }
      
      let html = '';
      let unreadCount = 0;
      
      APP_STATE.messages.forEach(msg => {
        const isUnread = !msg.read;
        if (isUnread) unreadCount++;
        
        html += `
          <div class="message-item ${isUnread ? 'message-unread' : ''}">
            <div class="bold">${msg.sender || 'Dispatch'}</div>
            <div>${msg.message || 'No message'}</div>
            <div style="font-size:11px;color:#999;margin-top:5px;">
              ${msg.time || new Date().toLocaleTimeString()}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      document.getElementById('unread-count').textContent = unreadCount;
    }

    function updateHomeStats() {
      const total = APP_STATE.deliveries.length;
      const delivered = APP_STATE.deliveries.filter(s => s.status === 'delivered').length;
      
      document.getElementById('today-stops').textContent = total;
      document.getElementById('delivered-count').textContent = delivered;
    }

    // =============================================
    // STOP MANAGEMENT
    // =============================================
    function openStop(stopId) {
      log(`Opening stop: ${stopId}`);
      
      const stop = APP_STATE.deliveries.find(s => s.id === stopId);
      if (!stop) {
        alert('Stop not found');
        return;
      }
      
      APP_STATE.currentStop = stop;
      document.getElementById('current-stop-id').value = stopId;
      
      // Update UI
      document.getElementById('stop-title').textContent = stop.customer_name || 'Stop Details';
      document.getElementById('stop-number').textContent = stop.stop_number || '?';
      document.getElementById('total-stops').textContent = APP_STATE.deliveries.length;
      document.getElementById('stop-id').textContent = stopId;
      
      // Build stop details HTML
      let detailsHTML = `
        <div class="stop-info-row">
          <div class="bold">Customer</div>
          <div>${stop.customer_name || 'Unknown'}</div>
        </div>
        
        <div class="stop-info-row">
          <div class="bold">Address</div>
          <div>${stop.address || 'No address'}</div>
          <div>${stop.city || ''}</div>
        </div>
        
        <div class="stop-info-row">
          <div class="bold">Packages</div>
          <div>${stop.packages || 1} package(s)</div>
        </div>
        
        <div class="stop-info-row">
          <div class="bold">Status</div>
          <div>
            <span class="status-badge status-${stop.status || 'pending'}">
              ${(stop.status || 'PENDING').toUpperCase()}
            </span>
          </div>
        </div>
        
        <div class="stop-info-row">
          <div class="bold">Notes</div>
          <div>${stop.notes || 'No special instructions'}</div>
        </div>
      `;
      
      document.getElementById('stop-details').innerHTML = detailsHTML;
      
      // Go to stop screen
      goToScreen('stop');
    }

    async function markAsDelivered() {
      if (!APP_STATE.currentStop) {
        alert('No stop selected');
        return;
      }
      
      const confirm = window.confirm('Mark this stop as delivered?');
      if (!confirm) return;
      
      showLoading();
      
      try {
        const stopId = APP_STATE.currentStop.id;
        const timestamp = new Date().toISOString();
        
        // Update local state
        APP_STATE.currentStop.status = 'delivered';
        APP_STATE.currentStop.delivered_at = timestamp;
        
        // Save to AppScript
        const response = await appScriptRequest('POST', {
          action: 'updateDelivery',
          courierId: APP_STATE.courierId,
          stopId: stopId,
          status: 'delivered',
          timestamp: timestamp
        });
        
        if (response && response.success) {
          alert('Stop marked as delivered!');
          
          // Update UI
          renderDeliveriesList();
          updateHomeStats();
          
          // Go back to list
          goToScreen('deliveries');
        } else {
          throw new Error('Server update failed');
        }
        
      } catch (error) {
        log(`Delivery mark error: ${error.message}`);
        
        // Save offline
        saveOfflineUpdate('delivered');
        alert('Saved offline. Will sync when connected.');
        
        // Update UI anyway
        renderDeliveriesList();
        updateHomeStats();
        goToScreen('deliveries');
      } finally {
        hideLoading();
      }
    }

    function markException() {
      if (!APP_STATE.currentStop) return;
      
      const exceptionType = prompt('Enter exception type:\n1. Not Home\n2. Refused\n3. Wrong Address\n4. Business Closed\n5. Other');
      if (!exceptionType) return;
      
      const notes = prompt('Additional notes:');
      
      APP_STATE.currentStop.status = 'exception';
      APP_STATE.currentStop.exception = exceptionType;
      APP_STATE.currentStop.exception_notes = notes;
      
      // Save offline
      saveOfflineUpdate('exception');
      
      alert('Exception recorded offline');
      goToScreen('deliveries');
    }

    // =============================================
    // SCANNING FUNCTIONS
    // =============================================
    let cameraStream = null;

    function initCamera() {
      log('Camera system initialized');
    }

    async function startCamera() {
      log('Starting camera...');
      
      try {
        // Stop existing stream
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
        }
        
        // Get video element
        const video = document.getElementById('camera-preview');
        
        // Request camera access
        const constraints = {
          video: {
            facingMode: APP_STATE.currentCamera,
            width: { ideal: 480 },
            height: { ideal: 640 }
          }
        };
        
        // For Android 2.3 compatibility, use simple constraints
        const simpleConstraints = {
          video: true
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(simpleConstraints);
        video.srcObject = cameraStream;
        APP_STATE.cameraActive = true;
        
        log('Camera started successfully');
        
      } catch (error) {
        log(`Camera error: ${error.message}`);
        alert('Camera access failed. Using manual entry only.');
        APP_STATE.cameraActive = false;
      }
    }

    function toggleCamera() {
      APP_STATE.currentCamera = APP_STATE.currentCamera === 'environment' ? 'user' : 'environment';
      startCamera();
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      
      const video = document.getElementById('camera-preview');
      if (video) {
        video.srcObject = null;
      }
      
      APP_STATE.cameraActive = false;
      log('Camera stopped');
    }

    function toggleFlash() {
      // Simple flash toggle for Android 2.3
      alert('Flash not supported on this device');
    }

    function captureAndScan() {
      log('Attempting to scan...');
      
      if (!APP_STATE.cameraActive) {
        startManualScan();
        return;
      }
      
      // For Android 2.3, we'll use a simple capture approach
      const video = document.getElementById('camera-preview');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // In production, add barcode scanning library here
      // For now, simulate scan
      simulateBarcodeScan();
    }

    function simulateBarcodeScan() {
      // Generate mock barcode
      const barcode = 'TRK' + Date.now().toString().slice(-10);
      processScannedBarcode(barcode);
    }

    function useMockBarcode() {
      const mockCodes = [
        'DHL123456789',
        'TRK987654321',
        'PKG112233445',
        'EXP556677889'
      ];
      const randomCode = mockCodes[Math.floor(Math.random() * mockCodes.length)];
      processScannedBarcode(randomCode);
    }

    function startManualScan() {
      const input = document.getElementById('manual-barcode');
      input.classList.remove('hidden');
      input.focus();
      
      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          processScannedBarcode(input.value.trim());
          input.value = '';
          input.classList.add('hidden');
        }
      };
    }

    async function processScannedBarcode(barcode) {
      if (!barcode || barcode.length < 3) {
        showScanResult('Invalid barcode', 'error');
        return;
      }
      
      log(`Processing barcode: ${barcode}`);
      showScanResult(`Scanned: ${barcode}`, 'warning');
      
      // Update last scan display
      APP_STATE.lastScan = barcode;
      document.getElementById('last-scan').textContent = barcode.substring(0, 10) + '...';
      
      // Get current stop ID
      const stopId = document.getElementById('current-stop-id').value;
      
      try {
        // Save to AppScript
        const response = await appScriptRequest('POST', {
          action: 'saveScan',
          courierId: APP_STATE.courierId,
          barcode: barcode,
          stopId: stopId,
          timestamp: new Date().toISOString()
        });
        
        if (response && response.success) {
          showScanResult('‚úì Scan saved successfully!', 'success');
          log(`Scan saved to server: ${barcode}`);
          
          // Auto-return after 2 seconds
          setTimeout(() => {
            goToScreen(stopId ? 'stop' : 'home');
          }, 2000);
          
        } else {
          throw new Error('Server save failed');
        }
        
      } catch (error) {
        log(`Scan save error: ${error.message}`);
        
        // Save offline
        saveOfflineScan(barcode, stopId);
        showScanResult('‚úì Saved offline', 'success');
        
        // Auto-return
        setTimeout(() => {
          goToScreen(stopId ? 'stop' : 'home');
        }, 2000);
      }
    }

    function showScanResult(message, type) {
      const resultEl = document.getElementById('scan-result');
      resultEl.textContent = message;
      resultEl.className = 'scan-result';
      
      if (type === 'success') resultEl.classList.add('scan-success');
      else if (type === 'error') resultEl.classList.add('scan-error');
      else if (type === 'warning') resultEl.classList.add('scan-warning');
    }

    // =============================================
    // SIGNATURE FUNCTIONS
    // =============================================
    let sigCanvas, sigCtx;
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    function initSignature() {
      sigCanvas = document.getElementById('signature-canvas');
      sigCtx = sigCanvas.getContext('2d');
      
      // Setup canvas
      sigCtx.strokeStyle = '#000000';
      sigCtx.lineWidth = 2;
      sigCtx.lineCap = 'round';
      sigCtx.lineJoin = 'round';
      
      // White background
      sigCtx.fillStyle = '#FFFFFF';
      sigCtx.fillRect(0, 0, sigCanvas.width, sigCanvas.height);
      
      // Add event listeners
      setupSignatureEvents();
      
      log('Signature pad initialized');
    }

    function setupSignatureEvents() {
      // Mouse events
      sigCanvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        [lastX, lastY] = [e.offsetX, e.offsetY];
      });
      
      sigCanvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        
        sigCtx.beginPath();
        sigCtx.moveTo(lastX, lastY);
        sigCtx.lineTo(e.offsetX, e.offsetY);
        sigCtx.stroke();
        
        [lastX, lastY] = [e.offsetX, e.offsetY];
      });
      
      sigCanvas.addEventListener('mouseup', () => isDrawing = false);
      sigCanvas.addEventListener('mouseout', () => isDrawing = false);
      
      // Touch events for Android
      sigCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = sigCanvas.getBoundingClientRect();
        
        isDrawing = true;
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
      });
      
      sigCanvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        
        const touch = e.touches[0];
        const rect = sigCanvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        sigCtx.beginPath();
        sigCtx.moveTo(lastX, lastY);
        sigCtx.lineTo(x, y);
        sigCtx.stroke();
        
        [lastX, lastY] = [x, y];
      });
      
      sigCanvas.addEventListener('touchend', () => isDrawing = false);
    }

    function clearSignature() {
      sigCtx.fillStyle = '#FFFFFF';
      sigCtx.fillRect(0, 0, sigCanvas.width, sigCanvas.height);
      log('Signature cleared');
    }

    async function saveSignature() {
      if (!APP_STATE.currentStop) {
        alert('No stop selected');
        return;
      }
      
      // Convert canvas to data URL
      const signatureData = sigCanvas.toDataURL('image/png');
      
      // Save locally
      document.getElementById('current-signature').value = signatureData;
      
      try {
        // Send to AppScript
        const response = await appScriptRequest('POST', {
          action: 'saveSignature',
          courierId: APP_STATE.courierId,
          stopId: APP_STATE.currentStop.id,
          signature: signatureData,
          timestamp: new Date().toISOString()
        });
        
        if (response && response.success) {
          alert('Signature saved successfully!');
          goToScreen('stop');
        } else {
          throw new Error('Server save failed');
        }
        
      } catch (error) {
        log(`Signature save error: ${error.message}`);
        
        // Save offline
        saveOfflineSignature(signatureData);
        alert('Signature saved offline');
        goToScreen('stop');
      }
    }

    // =============================================
    // APPSCRIPT COMMUNICATION
    // =============================================
    async function appScriptRequest(method, data) {
      // For Android 2.3 compatibility, use simple XHR
      return new Promise((resolve, reject) => {
        try {
          const xhr = new XMLHttpRequest();
          const url = CONFIG.APPSCRIPT_URL;
          
          // For GET requests, add params to URL
          let requestUrl = url;
          if (method === 'GET') {
            const params = new URLSearchParams(data).toString();
            requestUrl = `${url}?${params}`;
          }
          
          xhr.open(method, requestUrl, true);
          xhr.timeout = 10000; // 10 second timeout
          
          xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const response = JSON.parse(xhr.responseText);
                resolve(response);
              } catch (e) {
                resolve({ success: true, data: xhr.responseText });
              }
            } else {
              reject(new Error(`HTTP ${xhr.status}`));
            }
          };
          
          xhr.onerror = function() {
            reject(new Error('Network error'));
          };
          
          xhr.ontimeout = function() {
            reject(new Error('Request timeout'));
          };
          
          if (method === 'POST') {
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            const formData = new URLSearchParams(data).toString();
            xhr.send(formData);
          } else {
            xhr.send();
          }
          
        } catch (error) {
          reject(error);
        }
      });
    }

    async function checkConnection() {
      log('Checking connection...');
      
      try {
        // Simple ping to AppScript
        const response = await appScriptRequest('GET', {
          action: 'ping',
          courierId: APP_STATE.courierId
        });
        
        if (response && response.success) {
          APP_STATE.connectionStatus = 'online';
          document.getElementById('sync-status').textContent = 'ONLINE';
          document.getElementById('sync-indicator').style.background = '#00CC00';
          log('Connection: ONLINE');
        } else {
          throw new Error('No response');
        }
        
      } catch (error) {
        APP_STATE.connectionStatus = 'offline';
        document.getElementById('sync-status').textContent = 'OFFLINE';
        document.getElementById('sync-indicator').style.background = '#CC0000';
        log('Connection: OFFLINE');
      }
    }

    // =============================================
    // OFFLINE STORAGE
    // =============================================
    function saveOfflineScan(barcode, stopId) {
      const offlineScan = {
        type: 'scan',
        barcode: barcode,
        stopId: stopId,
        timestamp: new Date().toISOString(),
        courierId: APP_STATE.courierId
      };
      
      saveToOfflineQueue(offlineScan);
    }

    function saveOfflineSignature(signatureData) {
      const offlineSig = {
        type: 'signature',
        signature: signatureData,
        stopId: APP_STATE.currentStop.id,
        timestamp: new Date().toISOString(),
        courierId: APP_STATE.courierId
      };
      
      saveToOfflineQueue(offlineSig);
    }

    function saveOfflineUpdate(status) {
      const offlineUpdate = {
        type: 'status',
        stopId: APP_STATE.currentStop.id,
        status: status,
        timestamp: new Date().toISOString(),
        courierId: APP_STATE.courierId
      };
      
      saveToOfflineQueue(offlineUpdate);
    }

    function saveToOfflineQueue(data) {
      let queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
      queue.push(data);
      localStorage.setItem('offline_queue', JSON.stringify(queue));
      
      // Update pending count
      updatePendingCount();
      
      log(`Saved to offline queue: ${data.type}`);
    }

    async function syncOfflineData() {
      if (APP_STATE.connectionStatus !== 'online') return;
      
      const queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
      if (queue.length === 0) return;
      
      log(`Syncing ${queue.length} offline items...`);
      
      let failed = [];
      
      for (const item of queue) {
        try {
          await appScriptRequest('POST', {
            action: 'saveOffline',
            data: JSON.stringify(item)
          });
          
          log(`Synced: ${item.type} for ${item.stopId}`);
          
        } catch (error) {
          failed.push(item);
          log(`Sync failed for ${item.type}: ${error.message}`);
        }
      }
      
      // Update queue with failed items only
      localStorage.setItem('offline_queue', JSON.stringify(failed));
      updatePendingCount();
      
      if (failed.length === 0) {
        log('All offline data synced successfully');
      }
    }

    function updatePendingCount() {
      const queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
      document.getElementById('pending-count').textContent = queue.length;
    }

    // =============================================
    // UTILITY FUNCTIONS
    // =============================================
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `${timestamp}: ${message}`;
      
      // Add to state
      APP_STATE.logs.unshift(logEntry);
      if (APP_STATE.logs.length > 100) APP_STATE.logs.pop();
      
      // Console log
      console.log(logEntry);
    }

    function showDebug() {
      alert(`Debug Info:
Courier: ${APP_STATE.courierId}
Status: ${APP_STATE.connectionStatus}
Deliveries: ${APP_STATE.deliveries.length}
Offline Queue: ${JSON.parse(localStorage.getItem('offline_queue') || '[]').length}
Last Scan: ${APP_STATE.lastScan}
Camera: ${APP_STATE.cameraActive ? 'ON' : 'OFF'}
      `);
    }

    function forceSync() {
      showLoading();
      syncOfflineData().finally(() => {
        hideLoading();
        alert('Sync completed');
      });
    }

    function syncAllData() {
      showLoading();
      loadInitialData();
    }

    function refreshMessages() {
      loadMessages();
    }

    function takePhotoProof() {
      alert('Photo proof would open camera. On Android 2.3, use external camera app.');
    }

    function testConnection() {
      saveAppScriptUrl();
      checkConnection();
    }

    function clearAllData() {
      if (confirm('Clear ALL local data? This cannot be undone!')) {
        localStorage.clear();
        APP_STATE = {
          courierId: '',
          deliveries: [],
          currentStop: null,
          messages: [],
          pickups: [],
          offlineData: [],
          cameraActive: false,
          currentCamera: 'environment',
          lastScan: '',
          connectionStatus: 'offline',
          logs: []
        };
        
        alert('All data cleared. App will reload.');
        location.reload();
      }
    }

    function exportData() {
      const exportObj = {
        state: APP_STATE,
        offlineQueue: JSON.parse(localStorage.getItem('offline_queue') || '[]'),
        logs: APP_STATE.logs
      };
      
      const dataStr = JSON.stringify(exportObj, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `courier_export_${new Date().getTime()}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }

    function showLogs() {
      const logs = APP_STATE.logs.slice(0, 20).join('\n');
      alert(`Recent Logs:\n\n${logs}`);
    }

    // =============================================
    // MOCK DATA (FALLBACK)
    // =============================================
    function getMockDeliveries() {
      return [
        {
          id: 'DEL001',
          stop_number: 1,
          customer_name: 'John Smith',
          address: '123 Main Street',
          city: 'Silverton, OR 97381',
          packages: 2,
          status: 'pending',
          notes: 'Leave at front door'
        },
        {
          id: 'DEL002',
          stop_number: 2,
          customer_name: 'Acme Corporation',
          address: '456 Business Ave',
          city: 'Salem, OR 97301',
          packages: 5,
          status: 'pending',
          notes: 'Reception, 2nd floor'
        },
        {
          id: 'DEL003',
          stop_number: 3,
          customer_name: 'Mary Johnson',
          address: '789 Oak Lane',
          city: 'Silverton, OR 97381',
          packages: 1,
          status: 'delivered',
          notes: 'Signature required'
        }
      ];
    }

    function getMockMessages() {
      return [
        {
          id: 'MSG001',
          sender: 'Dispatch',
          message: 'Route updated. Check for new deliveries.',
          time: '08:30 AM',
          read: false
        },
        {
          id: 'MSG002',
          sender: 'Manager',
          message: 'Priority delivery at Acme Corp.',
          time: '09:15 AM',
          read: true
        }
      ];
    }

    function getMockPickups() {
      return [
        {
          id: 'PICK001',
          customer: 'XYZ Distributors',
          address: '321 Warehouse Rd',
          time: '3:00 PM',
          packages: 8
        }
      ];
    }

    // Initialize when page loads
    window.onload = function() {
      // Fix for Android 2.3 viewport
      document.body.style.width = '480px';
      document.body.style.height = '800px';
      
      // Prevent zoom
      document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) e.preventDefault();
      }, { passive: false });
      
      log('App fully loaded');
    };

  </script>
</body>
</html>
