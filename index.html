<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Courier Handheld System</title>
  <meta name="viewport" content="width=240, height=320, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    /* BASE LAYOUT: 240x320 QVGA */
    html, body {
      margin: 0;
      padding: 0;
      width: 240px;
      height: 320px;
      background: #000;
      font-family: Arial, sans-serif;
      font-size: 11px;
      color: #FFFFFF;
      overflow: hidden;
    }

    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 240px;
      height: 320px;
      background: #101010;
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* HEADER (48px) */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      width: 240px;
      height: 48px;
      background: #F7C600;
      color: #000000;
      font-weight: bold;
    }

    .header-top-row {
      position: absolute;
      top: 2px;
      left: 4px;
      right: 4px;
      height: 16px;
      font-size: 10px;
    }

    .header-top-left {
      float: left;
    }

    .header-top-right {
      float: right;
    }

    .header-title {
      position: absolute;
      bottom: 4px;
      left: 4px;
      right: 4px;
      text-align: center;
      font-size: 13px;
    }

    /* FOOTER (42px) */
    .footer {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 240px;
      height: 42px;
      background: #303030;
      color: #FFFFFF;
      font-size: 10px;
    }

    .footer-left {
      position: absolute;
      left: 6px;
      top: 14px;
    }

    .footer-right {
      position: absolute;
      right: 6px;
      top: 14px;
      text-align: right;
    }

    .sync-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #00CC33;
      border-radius: 4px;
      margin-left: 4px;
    }

    /* CONTENT AREA (230px) */
    .content {
      position: absolute;
      top: 48px;
      left: 0;
      width: 240px;
      height: 230px;
      background: #101010;
      overflow: hidden;
    }

    /* MAIN MENU GRID */
    .menu-grid {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 224px;
      height: 214px;
    }

    .menu-button {
      position: absolute;
      width: 104px;
      height: 96px;
      background: #1A1A1A;
      border-radius: 6px;
      border: 1px solid #444444;
      text-align: center;
      color: #FFFFFF;
      cursor: pointer;
    }

    .menu-button:active {
      background: #2A2A2A;
      border-color: #F7C600;
    }

    .menu-button-title {
      position: absolute;
      bottom: 10px;
      left: 4px;
      right: 4px;
      font-size: 13px;
      font-weight: bold;
    }

    .menu-button-icon {
      position: absolute;
      top: 18px;
      left: 0;
      right: 0;
      font-size: 26px;
    }

    .btn-scan { top: 0; left: 0; }
    .btn-deliver { top: 0; left: 116px; }
    .btn-pickup { top: 104px; left: 0; }
    .btn-msg { top: 104px; left: 116px; }

    /* BUTTONS */
    .btn {
      background: #2A2A2A;
      border: 1px solid #555555;
      border-radius: 4px;
      color: #FFFFFF;
      padding: 4px 6px;
      font-size: 11px;
      cursor: pointer;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn:active:not(:disabled) {
      background: #3A3A3A;
    }

    .btn-primary {
      background: #F7C600;
      color: #000000;
      border-color: #C9A200;
      font-weight: bold;
    }

    .btn-primary:active {
      background: #D8B200;
    }

    .btn-block {
      display: block;
      width: 100%;
      text-align: center;
      box-sizing: border-box;
    }

    .btn-row {
      margin-top: 6px;
    }

    /* LISTS */
    .list {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      bottom: 4px;
      overflow-y: auto;
      border: 1px solid #333333;
      background: #181818;
    }

    .list-item {
      padding: 4px;
      border-bottom: 1px solid #333333;
      font-size: 11px;
      cursor: pointer;
    }

    .list-item:active {
      background: #2A2A2A;
    }

    .list-item-title {
      font-weight: bold;
      font-size: 12px;
    }

    .list-item-sub {
      font-size: 10px;
      color: #CCCCCC;
    }

    /* SCAN SCREEN */
    .scan-view {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      bottom: 40px;
      border: 1px solid #444444;
      background: #000000;
      text-align: center;
    }

    .scan-crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 120px;
      height: 60px;
      margin-left: -60px;
      margin-top: -30px;
      border: 1px dashed #555555;
    }

    .scan-label {
      position: absolute;
      bottom: 6px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      color: #888888;
    }

    .scan-buttons {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 4px;
      height: 32px;
      text-align: center;
    }

    .scan-buttons .btn {
      margin: 0 2px;
    }

    /* DELIVERY STOP */
    .stop-header {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      height: 52px;
      border: 1px solid #333333;
      background: #181818;
      padding: 4px;
      box-sizing: border-box;
      font-size: 11px;
      overflow-y: auto;
    }

    .stop-body {
      position: absolute;
      top: 60px;
      left: 4px;
      right: 4px;
      bottom: 4px;
    }

    .stop-buttons .btn {
      margin-bottom: 4px;
    }

    /* SIGNATURE SCREEN */
    .signature-pad {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      bottom: 40px;
      background: #FFFFFF;
      border: 1px solid #444444;
    }

    .signature-buttons {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 4px;
      text-align: center;
    }

    /* EXCEPTIONS */
    .exception-detail {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      bottom: 40px;
      border: 1px solid #333333;
      background: #181818;
      padding: 4px;
      box-sizing: border-box;
      font-size: 11px;
      overflow-y: auto;
    }

    .field-label {
      font-size: 10px;
      color: #CCCCCC;
      margin-top: 4px;
    }

    .field-input {
      width: 100%;
      box-sizing: border-box;
      font-size: 11px;
      padding: 2px;
      margin-top: 2px;
      background: #000000;
      color: #FFFFFF;
      border: 1px solid #555555;
    }

    .field-input:focus {
      border-color: #F7C600;
      outline: none;
    }

    textarea.field-input {
      resize: none;
      height: 60px;
    }

    /* LOGIN SCREEN */
    .login-container {
      position: absolute;
      top: 80px;
      left: 20px;
      right: 20px;
      text-align: center;
    }

    .login-input {
      width: 180px;
      height: 30px;
      font-size: 16px;
      text-align: center;
      margin-bottom: 10px;
      background: #000;
      color: #FFF;
      border: 1px solid #555;
    }

    .login-input:focus {
      border-color: #F7C600;
      outline: none;
    }

    /* STATUS & LOADING */
    .status-text {
      font-size: 10px;
      margin-top: 4px;
    }

    .loading {
      color: #F7C600;
    }

    .success {
      color: #00CC33;
    }

    .error {
      color: #CC0000;
    }

    .warning {
      color: #FF9900;
    }

    .hidden {
      display: none !important;
    }

    /* LOADING SPINNER */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #F7C600;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* TOAST NOTIFICATION */
    .toast {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 11px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .toast-success {
      background: #00CC33;
      color: white;
    }

    .toast-error {
      background: #CC0000;
      color: white;
    }

    .toast-warning {
      background: #FF9900;
      color: white;
    }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div id="screen-login" class="screen active">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left">Courier System</div>
        <div class="header-top-right">v1.0</div>
      </div>
      <div class="header-title">Login Required</div>
    </div>
    <div class="content">
      <div class="login-container">
        <div style="margin-bottom: 20px; font-size: 14px;">Enter Courier ID:</div>
        <input type="text" id="courier-id-input" class="login-input" value="" maxlength="10" placeholder="Enter ID" onkeypress="if(event.key==='Enter')performLogin()">
        <div class="btn-row">
          <button class="btn btn-primary btn-block" onclick="performLogin()" id="login-btn">LOGIN</button>
        </div>
        <div id="login-status" class="status-text"></div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left">Device: CS400</div>
      <div class="footer-right"><span id="network-status">Checking...</span></div>
    </div>
  </div>

  <!-- HOME SCREEN -->
  <div id="screen-home" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="home-time">--:-- | -- | --%</div>
        <div class="header-top-right" id="home-courier">ID: --</div>
      </div>
      <div class="header-title">Courier Menu</div>
    </div>
    <div class="content">
      <div class="menu-grid">
        <div class="menu-button btn-scan" onclick="goToScan()">
          <div class="menu-button-icon">‚ñ¶</div>
          <div class="menu-button-title">SCAN</div>
        </div>
        <div class="menu-button btn-deliver" onclick="loadDeliveries()">
          <div class="menu-button-icon">‚óé</div>
          <div class="menu-button-title">DELIVERIES</div>
        </div>
        <div class="menu-button btn-pickup" onclick="loadPickups()">
          <div class="menu-button-icon">‚¨Ü</div>
          <div class="menu-button-title">PICKUPS</div>
        </div>
        <div class="menu-button btn-msg" onclick="loadMessages()">
          <div class="menu-button-icon">‚úâ</div>
          <div class="menu-button-title">MESSAGES</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left">Route: <span id="route-info">--/--</span></div>
      <div class="footer-right">Sync <span class="sync-dot" id="sync-dot"></span></div>
    </div>
  </div>

  <!-- DELIVERIES LIST -->
  <div id="screen-deliveries" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="deliveries-time">--:-- | -- | --%</div>
        <div class="header-top-right" id="deliveries-route">Route: --/--</div>
      </div>
      <div class="header-title">Deliveries</div>
    </div>
    <div class="content">
      <div class="list" id="deliveries-list">
        <div class="list-item">
          <div class="list-item-title">Loading deliveries...</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-home')">‚óÄ Menu</span></div>
      <div class="footer-right">Count: <span id="deliveries-count">--</span></div>
    </div>
  </div>

  <!-- DELIVERY STOP DETAIL -->
  <div id="screen-stop" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="stop-time">--:-- | -- | --%</div>
        <div class="header-top-right" id="stop-number">Stop --</div>
      </div>
      <div class="header-title" id="stop-name">--</div>
    </div>
    <div class="content">
      <div class="stop-header" id="stop-details">
        <div>Loading stop details...</div>
      </div>
      <div class="stop-body">
        <div class="stop-buttons">
          <div class="btn-row">
            <button class="btn btn-primary btn-block" onclick="goToScan()">Scan Package</button>
          </div>
          <div class="btn-row">
            <button class="btn btn-block" onclick="markAsDelivered()">Mark Delivered</button>
          </div>
          <div class="btn-row">
            <button class="btn btn-block" onclick="go('screen-exceptions')">Mark Exception</button>
          </div>
          <div class="btn-row">
            <button class="btn btn-block" onclick="showStopHistory()">View History</button>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-deliveries')">‚óÄ Back</span></div>
      <div class="footer-right">Status: <span id="stop-status">--</span></div>
    </div>
  </div>

  <!-- SCAN SCREEN -->
  <div id="screen-scan" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="scan-time">--:-- | -- | --%</div>
        <div class="header-top-right">Scanner</div>
      </div>
      <div class="header-title">Scan Package</div>
    </div>
    <div class="content">
      <div class="scan-view">
        <div class="scan-crosshair"></div>
        <div class="scan-label">Align barcode within box</div>
        <div style="position: absolute; top: 10px; left: 0; right: 0; font-size: 10px; color: #F7C600;">
          Stop: <span id="current-stop-scan">--</span>
        </div>
      </div>
      <div class="scan-buttons">
        <button class="btn" onclick="manualBarcodeEntry()">Manual Entry</button>
        <button class="btn" onclick="clearLastScan()">Clear Last</button>
        <button class="btn" onclick="viewScanHistory()">History</button>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="goBackFromScan()">‚óÄ Back</span></div>
      <div class="footer-right">Today: <span id="today-scans">0</span></div>
    </div>
  </div>

  <!-- EXCEPTIONS LIST -->
  <div id="screen-exceptions" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="exceptions-time">--:-- | -- | --%</div>
        <div class="header-top-right">Exceptions</div>
      </div>
      <div class="header-title">Select Exception</div>
    </div>
    <div class="content">
      <div class="list" id="exceptions-list">
        <div class="list-item">
          <div class="list-item-title">Loading exceptions...</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-stop')">‚óÄ Stop</span></div>
      <div class="footer-right">Select</div>
    </div>
  </div>

  <!-- EXCEPTION DETAIL -->
  <div id="screen-exception-detail" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="exception-detail-time">--:-- | -- | --%</div>
        <div class="header-top-right">Exception</div>
      </div>
      <div class="header-title" id="exception-title">Exception</div>
    </div>
    <div class="content">
      <div class="exception-detail">
        <div class="field-label">Notes (Required)</div>
        <textarea class="field-input" id="exception-notes" rows="3" placeholder="Describe the issue..."></textarea>

        <div class="field-label">Action Taken</div>
        <select class="field-input" id="exception-action">
          <option value="">Select action...</option>
          <option value="LEFT_AT_DOOR">Left at door</option>
          <option value="LEFT_WITH_NEIGHBOR">Left with neighbor</option>
          <option value="RETURN_TO_DEPOT">Return to depot</option>
          <option value="RESCHEDULE">Reschedule delivery</option>
          <option value="OTHER">Other</option>
        </select>

        <div class="field-label">Attempted Contact</div>
        <select class="field-input" id="exception-contact">
          <option value="NONE">No contact</option>
          <option value="DOORBELL">Rang doorbell</option>
          <option value="PHONE_CALL">Phone call</option>
          <option value="SMS">SMS</option>
        </select>
      </div>
      <div class="signature-buttons">
        <button class="btn" onclick="go('screen-exceptions')">Cancel</button>
        <button class="btn btn-primary" onclick="saveException()">Save Exception</button>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-exceptions')">‚óÄ Back</span></div>
      <div class="footer-right">Save</div>
    </div>
  </div>

  <!-- PICKUPS LIST -->
  <div id="screen-pickups" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="pickups-time">--:-- | -- | --%</div>
        <div class="header-top-right">Pickups</div>
      </div>
      <div class="header-title">Pickups</div>
    </div>
    <div class="content">
      <div class="list" id="pickups-list">
        <div class="list-item">
          <div class="list-item-title">Loading pickups...</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-home')">‚óÄ Menu</span></div>
      <div class="footer-right">Count: <span id="pickups-count">--</span></div>
    </div>
  </div>

  <!-- SCAN HISTORY -->
  <div id="screen-scan-history" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="history-time">--:-- | -- | --%</div>
        <div class="header-top-right">History</div>
      </div>
      <div class="header-title">Scan History</div>
    </div>
    <div class="content">
      <div class="list" id="scan-history-list">
        <div class="list-item">
          <div class="list-item-title">Loading history...</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-scan')">‚óÄ Scan</span></div>
      <div class="footer-right">Total: <span id="history-count">--</span></div>
    </div>
  </div>

  <!-- STOP HISTORY -->
  <div id="screen-stop-history" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="stop-history-time">--:-- | -- | --%</div>
        <div class="header-top-right">History</div>
      </div>
      <div class="header-title">Stop History</div>
    </div>
    <div class="content">
      <div class="list" id="stop-history-list">
        <div class="list-item">
          <div class="list-item-title">Loading stop history...</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-stop')">‚óÄ Stop</span></div>
      <div class="footer-right">Events: <span id="stop-history-count">--</span></div>
    </div>
  </div>

<script>
// ==============================================
// CONFIGURATION - REPLACE WITH YOUR URL
// ==============================================
const CONFIG = {
  API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxwMeFKiDmu5H1D62uMNMHXunFD6_rErktvDhKZXL4sKiJt6QyAcVtH5BcBzTRrZhsn/exec',
  COURIER_ID: null,
  CURRENT_ROUTE: null,
  CURRENT_STOP: null,
  CURRENT_EXCEPTION: null,
  LAST_SCREEN: 'screen-home',
  SYNC_QUEUE: []
};

// ==============================================
// CORE API FUNCTIONS - STRICT PRODUCTION
// ==============================================
async function apiCall(action, data = {}) {
  const params = new URLSearchParams();
  params.append('action', action);
  
  Object.keys(data).forEach(key => {
    if (data[key] !== null && data[key] !== undefined) {
      params.append(key, String(data[key]));
    }
  });
  
  const url = `${CONFIG.API_BASE_URL}?${params.toString()}`;
  
  try {
    const response = await fetch(url, { method: 'POST' });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.message || 'API call failed');
    }
    
    return result;
  } catch (error) {
    console.error('API Error:', error);
    
    // Queue for offline sync
    const queueId = queueForSync(action, data);
    
    return {
      success: false,
      queued: true,
      queueId: queueId,
      error: error.message
    };
  }
}

function queueForSync(action, data) {
  const queueItem = {
    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    action: action,
    data: data,
    timestamp: new Date().toISOString(),
    attempts: 0
  };
  
  CONFIG.SYNC_QUEUE.push(queueItem);
  saveToLocalStorage('sync_queue', CONFIG.SYNC_QUEUE);
  updateSyncStatus();
  
  return queueItem.id;
}

async function processSyncQueue() {
  if (CONFIG.SYNC_QUEUE.length === 0 || !navigator.onLine) return;
  
  const item = CONFIG.SYNC_QUEUE[0];
  
  try {
    const result = await apiCall(item.action, item.data);
    
    if (result.success && !result.queued) {
      CONFIG.SYNC_QUEUE.shift();
      saveToLocalStorage('sync_queue', CONFIG.SYNC_QUEUE);
      updateSyncStatus();
      showToast('Sync completed', 'success');
      
      // Process next item
      if (CONFIG.SYNC_QUEUE.length > 0) {
        setTimeout(processSyncQueue, 1000);
      }
    } else {
      item.attempts++;
      if (item.attempts >= 3) {
        CONFIG.SYNC_QUEUE.shift();
        showToast('Sync failed after 3 attempts', 'error');
      }
      saveToLocalStorage('sync_queue', CONFIG.SYNC_QUEUE);
    }
  } catch (error) {
    console.error('Sync error:', error);
  }
}

// ==============================================
// AUTHENTICATION
// ==============================================
async function performLogin() {
  const courierId = document.getElementById('courier-id-input').value.trim();
  if (!courierId) {
    showStatus('Please enter Courier ID', 'error');
    return;
  }
  
  const loginBtn = document.getElementById('login-btn');
  loginBtn.disabled = true;
  loginBtn.textContent = 'AUTHENTICATING...';
  
  showStatus('Connecting to server...', 'loading');
  
  try {
    const result = await apiCall('login', { courierId: courierId });
    
    if (result.queued) {
      showStatus('Offline mode - using last known data', 'warning');
      // Try to load from localStorage
      const savedData = loadFromLocalStorage(`courier_${courierId}`);
      if (savedData) {
        result.courierId = savedData.courierId;
        result.name = savedData.name;
      }
    }
    
    if (result.success) {
      CONFIG.COURIER_ID = courierId;
      
      // Save to localStorage for offline reference
      saveToLocalStorage('current_courier', {
        id: courierId,
        name: result.name || `Courier ${courierId}`,
        loginTime: new Date().toISOString()
      });
      
      // Update UI
      document.getElementById('home-courier').textContent = `ID: ${courierId}`;
      if (result.name) {
        document.getElementById('home-title').textContent = `Welcome ${result.name}`;
      }
      
      showStatus('Login successful', 'success');
      
      // Load today's route
      await loadTodayRoute();
      
      // Switch to home screen
      setTimeout(() => {
        go('screen-home');
        updateClock();
        startClockUpdate();
      }, 1000);
      
    } else {
      throw new Error(result.message || 'Login failed');
    }
    
  } catch (error) {
    showStatus(`Login failed: ${error.message}`, 'error');
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'LOGIN';
  }
}

// ==============================================
// ROUTE & STOP MANAGEMENT
// ==============================================
async function loadTodayRoute() {
  if (!CONFIG.COURIER_ID) return;
  
  const today = new Date().toISOString().split('T')[0];
  
  try {
    const result = await apiCall('getRoutes', {
      courierId: CONFIG.COURIER_ID,
      date: today
    });
    
    if (result.success && result.routes && result.routes.length > 0) {
      CONFIG.CURRENT_ROUTE = result.routes[0].routeId;
      
      // Update UI
      const route = result.routes[0];
      document.getElementById('route-info').textContent = 
        `${route.completedStops || 0}/${route.totalStops || 0}`;
      document.getElementById('deliveries-route').textContent = 
        `Route: ${route.completedStops || 0}/${route.totalStops || 0}`;
      
      // Save route info
      saveToLocalStorage('current_route', route);
      
    } else if (result.queued) {
      // Try to load from localStorage
      const savedRoute = loadFromLocalStorage('current_route');
      if (savedRoute) {
        CONFIG.CURRENT_ROUTE = savedRoute.routeId;
        document.getElementById('route-info').textContent = 
          `${savedRoute.completedStops || 0}/${savedRoute.totalStops || 0}`;
      } else {
        showToast('No route assigned for today', 'warning');
      }
    } else {
      showToast('No route assigned for today', 'warning');
    }
    
  } catch (error) {
    console.error('Load route error:', error);
  }
}

async function loadDeliveries() {
  if (!CONFIG.CURRENT_ROUTE) {
    showToast('No active route found', 'error');
    return;
  }
  
  go('screen-deliveries');
  
  try {
    const result = await apiCall('getStops', {
      routeId: CONFIG.CURRENT_ROUTE
    });
    
    if (result.success && result.stops) {
      const deliveries = result.stops.filter(stop => stop.type === 'DELIVERY');
      displayDeliveriesList(deliveries);
      
      // Save to localStorage for offline
      saveToLocalStorage('current_deliveries', deliveries);
      
    } else if (result.queued) {
      // Load from localStorage
      const savedDeliveries = loadFromLocalStorage('current_deliveries') || [];
      displayDeliveriesList(savedDeliveries);
      
    } else {
      document.getElementById('deliveries-list').innerHTML = `
        <div class="list-item">
          <div class="list-item-title">No deliveries found</div>
        </div>`;
    }
    
  } catch (error) {
    console.error('Load deliveries error:', error);
    showToast('Failed to load deliveries', 'error');
  }
}

function displayDeliveriesList(deliveries) {
  const listElement = document.getElementById('deliveries-list');
  
  if (!deliveries || deliveries.length === 0) {
    listElement.innerHTML = `
      <div class="list-item">
        <div class="list-item-title">No deliveries scheduled</div>
      </div>`;
    document.getElementById('deliveries-count').textContent = '0';
    return;
  }
  
  const listHtml = deliveries.map(stop => `
    <div class="list-item" onclick="loadStopDetail('${stop.stopId}')">
      <div class="list-item-title">${stop.name}</div>
      <div class="list-item-sub">${stop.address}, ${stop.city}</div>
      <div class="list-item-sub">
        Parcels: ${stop.parcelCount || 1} | Status: <span class="${getStatusColor(stop.status)}">${stop.status || 'PENDING'}</span>
      </div>
    </div>
  `).join('');
  
  listElement.innerHTML = listHtml;
  document.getElementById('deliveries-count').textContent = deliveries.length;
}

async function loadStopDetail(stopId) {
  CONFIG.CURRENT_STOP = stopId;
  
  try {
    // First try to get from current deliveries
    const deliveries = loadFromLocalStorage('current_deliveries') || [];
    let stop = deliveries.find(s => s.stopId === stopId);
    
    if (!stop) {
      // Try API call
      const result = await apiCall('getStop', { stopId: stopId });
      if (result.success && result.stop) {
        stop = result.stop;
      }
    }
    
    if (stop) {
      updateStopDetailScreen(stop);
      go('screen-stop');
    } else {
      showToast('Stop not found', 'error');
    }
    
  } catch (error) {
    console.error('Load stop error:', error);
    showToast('Failed to load stop details', 'error');
  }
}

function updateStopDetailScreen(stop) {
  document.getElementById('stop-name').textContent = stop.name;
  document.getElementById('stop-number').textContent = `Stop ${stop.stopNumber || ''}`;
  document.getElementById('stop-status').textContent = stop.status || 'PENDING';
  document.getElementById('stop-status').className = getStatusColor(stop.status);
  
  const detailsHtml = `
    <div><b>Address:</b> ${stop.address || ''}</div>
    <div>${stop.city || ''}, ${stop.zip || ''}</div>
    ${stop.phone ? `<div><b>Phone:</b> ${stop.phone}</div>` : ''}
    <div><b>Parcels:</b> ${stop.parcelCount || 1}</div>
    ${stop.notes ? `<div><b>Notes:</b> ${stop.notes}</div>` : ''}
  `;
  
  document.getElementById('stop-details').innerHTML = detailsHtml;
  
  // Update scan screen reference
  document.getElementById('current-stop-scan').textContent = stop.name;
}

// ==============================================
// SCAN FUNCTIONS - PRODUCTION ONLY
// ==============================================
function goToScan() {
  if (!CONFIG.CURRENT_STOP) {
    showToast('Please select a stop first', 'error');
    go('screen-deliveries');
    return;
  }
  
  CONFIG.LAST_SCREEN = document.querySelector('.screen.active').id;
  updateScanScreen();
  go('screen-scan');
}

function updateScanScreen() {
  // Update today's scan count
  const today = new Date().toISOString().split('T')[0];
  const scans = loadFromLocalStorage('scans') || [];
  const todayScans = scans.filter(s => s.scanTime && s.scanTime.startsWith(today));
  document.getElementById('today-scans').textContent = todayScans.length;
}

async function manualBarcodeEntry() {
  const barcode = prompt('Enter package barcode:');
  if (barcode && barcode.trim()) {
    await saveScan(barcode.trim(), 'MANUAL');
  }
}

async function saveScan(barcode, scanType = 'SCAN') {
  if (!CONFIG.CURRENT_STOP || !CONFIG.COURIER_ID) {
    showToast('No stop selected', 'error');
    return;
  }
  
  if (!barcode || barcode.trim().length < 3) {
    showToast('Invalid barcode', 'error');
    return;
  }
  
  const scanData = {
    stopId: CONFIG.CURRENT_STOP,
    courierId: CONFIG.COURIER_ID,
    barcode: barcode.trim(),
    scanType: scanType,
    scanTime: new Date().toISOString()
  };
  
  try {
    const result = await apiCall('saveScan', scanData);
    
    if (result.success) {
      // Save locally for history
      const scans = loadFromLocalStorage('scans') || [];
      scans.push(scanData);
      saveToLocalStorage('scans', scans);
      
      // Update UI
      updateScanScreen();
      showToast(`Scan saved: ${barcode}`, 'success');
      
      // Update stop status if needed
      if (scanType === 'SCAN') {
        await updateStopStatus(CONFIG.CURRENT_STOP, 'SCANNED');
      }
      
    } else if (result.queued) {
      // Queue for sync
      scanData.queued = true;
      const scans = loadFromLocalStorage('scans') || [];
      scans.push(scanData);
      saveToLocalStorage('scans', scans);
      
      updateScanScreen();
      showToast(`Scan queued: ${barcode}`, 'warning');
    }
    
  } catch (error) {
    console.error('Save scan error:', error);
    showToast('Failed to save scan', 'error');
  }
}

async function clearLastScan() {
  const scans = loadFromLocalStorage('scans') || [];
  if (scans.length === 0) {
    showToast('No scans to clear', 'error');
    return;
  }
  
  const lastScan = scans[scans.length - 1];
  if (confirm(`Remove last scan: ${lastScan.barcode}?`)) {
    scans.pop();
    saveToLocalStorage('scans', scans);
    updateScanScreen();
    showToast('Last scan removed', 'success');
  }
}

async function viewScanHistory() {
  go('screen-scan-history');
  
  try {
    const scans = loadFromLocalStorage('scans') || [];
    
    if (scans.length === 0) {
      document.getElementById('scan-history-list').innerHTML = `
        <div class="list-item">
          <div class="list-item-title">No scan history</div>
        </div>`;
      document.getElementById('history-count').textContent = '0';
      return;
    }
    
    // Get stops for reference
    const stops = loadFromLocalStorage('current_deliveries') || [];
    
    const historyHtml = scans.slice().reverse().map(scan => {
      const stop = stops.find(s => s.stopId === scan.stopId);
      const time = scan.scanTime ? new Date(scan.scanTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
      
      return `
        <div class="list-item">
          <div class="list-item-title">${scan.barcode}</div>
          <div class="list-item-sub">${stop ? stop.name : 'Unknown Stop'}</div>
          <div class="list-item-sub">${time} | ${scan.scanType || 'SCAN'}</div>
        </div>
      `;
    }).join('');
    
    document.getElementById('scan-history-list').innerHTML = historyHtml;
    document.getElementById('history-count').textContent = scans.length;
    
  } catch (error) {
    console.error('Load scan history error:', error);
  }
}

// ==============================================
// DELIVERY & EXCEPTION FUNCTIONS
// ==============================================
async function markAsDelivered() {
  if (!CONFIG.CURRENT_STOP) return;
  
  if (confirm('Mark this stop as DELIVERED?')) {
    try {
      const result = await apiCall('updateStop', {
        stopId: CONFIG.CURRENT_STOP,
        status: 'DELIVERED',
        updateTime: new Date().toISOString()
      });
      
      if (result.success) {
        // Update local data
        const deliveries = loadFromLocalStorage('current_deliveries') || [];
        const stopIndex = deliveries.findIndex(s => s.stopId === CONFIG.CURRENT_STOP);
        if (stopIndex !== -1) {
          deliveries[stopIndex].status = 'DELIVERED';
          saveToLocalStorage('current_deliveries', deliveries);
        }
        
        showToast('Stop marked as delivered', 'success');
        go('screen-deliveries');
        
        // Update route progress
        await loadTodayRoute();
        
      } else if (result.queued) {
        showToast('Delivery status queued for sync', 'warning');
        go('screen-deliveries');
      }
      
    } catch (error) {
      console.error('Mark delivered error:', error);
      showToast('Failed to update status', 'error');
    }
  }
}

async function loadExceptions() {
  go('screen-exceptions');
  
  const exceptions = [
    { id: 'NOT_HOME', name: 'Customer Not Home' },
    { id: 'REFUSED', name: 'Package Refused' },
    { id: 'WRONG_ADDRESS', name: 'Wrong Address' },
    { id: 'BUSINESS_CLOSED', name: 'Business Closed' },
    { id: 'DAMAGED', name: 'Package Damaged' },
    { id: 'INACCESSIBLE', name: 'Location Inaccessible' },
    { id: 'WEATHER', name: 'Weather Delay' },
    { id: 'OTHER', name: 'Other Issue' }
  ];
  
  const listHtml = exceptions.map(ex => `
    <div class="list-item" onclick="openExceptionDetail('${ex.id}', '${ex.name}')">
      <div class="list-item-title">${ex.name}</div>
    </div>
  `).join('');
  
  document.getElementById('exceptions-list').innerHTML = listHtml;
}

function openExceptionDetail(exceptionId, exceptionName) {
  CONFIG.CURRENT_EXCEPTION = exceptionId;
  document.getElementById('exception-title').textContent = exceptionName;
  
  // Clear form
  document.getElementById('exception-notes').value = '';
  document.getElementById('exception-action').value = '';
  document.getElementById('exception-contact').value = 'NONE';
  
  go('screen-exception-detail');
}

async function saveException() {
  if (!CONFIG.CURRENT_STOP || !CONFIG.CURRENT_EXCEPTION) {
    showToast('Please select stop and exception type', 'error');
    return;
  }
  
  const notes = document.getElementById('exception-notes').value.trim();
  if (!notes) {
    showToast('Please enter exception notes', 'error');
    return;
  }
  
  const action = document.getElementById('exception-action').value;
  const contact = document.getElementById('exception-contact').value;
  
  const exceptionData = {
    stopId: CONFIG.CURRENT_STOP,
    courierId: CONFIG.COURIER_ID,
    exceptionType: CONFIG.CURRENT_EXCEPTION,
    notes: notes,
    actionTaken: action,
    customerContacted: contact,
    exceptionTime: new Date().toISOString()
  };
  
  try {
    const result = await apiCall('saveException', exceptionData);
    
    if (result.success) {
      // Update local stop status
      const deliveries = loadFromLocalStorage('current_deliveries') || [];
      const stopIndex = deliveries.findIndex(s => s.stopId === CONFIG.CURRENT_STOP);
      if (stopIndex !== -1) {
        deliveries[stopIndex].status = 'EXCEPTION';
        saveToLocalStorage('current_deliveries', deliveries);
      }
      
      // Save exception locally
      const exceptions = loadFromLocalStorage('exceptions') || [];
      exceptions.push(exceptionData);
      saveToLocalStorage('exceptions', exceptions);
      
      showToast('Exception saved', 'success');
      go('screen-stop');
      
    } else if (result.queued) {
      showToast('Exception queued for sync', 'warning');
      go('screen-stop');
    }
    
  } catch (error) {
    console.error('Save exception error:', error);
    showToast('Failed to save exception', 'error');
  }
}

// ==============================================
// PICKUP FUNCTIONS
// ==============================================
async function loadPickups() {
  if (!CONFIG.CURRENT_ROUTE) {
    showToast('No active route found', 'error');
    return;
  }
  
  go('screen-pickups');
  
  try {
    const result = await apiCall('getStops', {
      routeId: CONFIG.CURRENT_ROUTE
    });
    
    if (result.success && result.stops) {
      const pickups = result.stops.filter(stop => stop.type === 'PICKUP');
      displayPickupsList(pickups);
      
      // Save to localStorage
      saveToLocalStorage('current_pickups', pickups);
      
    } else if (result.queued) {
      const savedPickups = loadFromLocalStorage('current_pickups') || [];
      displayPickupsList(savedPickups);
    } else {
      document.getElementById('pickups-list').innerHTML = `
        <div class="list-item">
          <div class="list-item-title">No pickups scheduled</div>
        </div>`;
    }
    
  } catch (error) {
    console.error('Load pickups error:', error);
  }
}

function displayPickupsList(pickups) {
  const listElement = document.getElementById('pickups-list');
  
  if (!pickups || pickups.length === 0) {
    listElement.innerHTML = `
      <div class="list-item">
        <div class="list-item-title">No pickups scheduled</div>
      </div>`;
    document.getElementById('pickups-count').textContent = '0';
    return;
  }
  
  const listHtml = pickups.map(stop => `
    <div class="list-item" onclick="loadStopDetail('${stop.stopId}')">
      <div class="list-item-title">${stop.name}</div>
      <div class="list-item-sub">${stop.address}, ${stop.city}</div>
      <div class="list-item-sub">Expected: ${stop.parcelCount || '?'} parcels</div>
    </div>
  `).join('');
  
  listElement.innerHTML = listHtml;
  document.getElementById('pickups-count').textContent = pickups.length;
}

// ==============================================
// HISTORY & UTILITY FUNCTIONS
// ==============================================
async function showStopHistory() {
  if (!CONFIG.CURRENT_STOP) return;
  
  go('screen-stop-history');
  
  try {
    // Combine scans and exceptions for this stop
    const scans = loadFromLocalStorage('scans') || [];
    const exceptions = loadFromLocalStorage('exceptions') || [];
    
    const stopScans = scans.filter(s => s.stopId === CONFIG.CURRENT_STOP);
    const stopExceptions = exceptions.filter(e => e.stopId === CONFIG.CURRENT_STOP);
    
    const allEvents = [
      ...stopScans.map(s => ({ ...s, type: 'SCAN' })),
      ...stopExceptions.map(e => ({ ...e, type: 'EXCEPTION' }))
    ].sort((a, b) => new Date(b.timestamp || b.scanTime || b.exceptionTime) - new Date(a.timestamp || a.scanTime || a.exceptionTime));
    
    if (allEvents.length === 0) {
      document.getElementById('stop-history-list').innerHTML = `
        <div class="list-item">
          <div class="list-item-title">No history for this stop</div>
        </div>`;
      document.getElementById('stop-history-count').textContent = '0';
      return;
    }
    
    const historyHtml = allEvents.map(event => {
      const time = event.scanTime || event.exceptionTime;
      const timeStr = time ? new Date(time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
      
      if (event.type === 'SCAN') {
        return `
          <div class="list-item">
            <div class="list-item-title">üì¶ Scan: ${event.barcode}</div>
            <div class="list-item-sub">${timeStr} | ${event.scanType || 'SCAN'}</div>
          </div>
        `;
      } else {
        return `
          <div class="list-item">
            <div class="list-item-title">‚ö†Ô∏è Exception: ${event.exceptionType}</div>
            <div class="list-item-sub">${timeStr}</div>
            <div class="list-item-sub">${event.notes || ''}</div>
          </div>
        `;
      }
    }).join('');
    
    document.getElementById('stop-history-list').innerHTML = historyHtml;
    document.getElementById('stop-history-count').textContent = allEvents.length;
    
  } catch (error) {
    console.error('Load stop history error:', error);
  }
}

// ==============================================
// UI UTILITY FUNCTIONS
// ==============================================
function go(screenId) {
  document.querySelectorAll('.screen').forEach(screen => {
    screen.classList.remove('active');
  });
  
  const screen = document.getElementById(screenId);
  if (screen) {
    screen.classList.add('active');
    
    // Initialize specific screens
    if (screenId === 'screen-exceptions') {
      loadExceptions();
    } else if (screenId === 'screen-scan-history') {
      viewScanHistory();
    }
  }
}

function goBackFromScan() {
  go(CONFIG.LAST_SCREEN || 'screen-home');
}

function updateClock() {
  const now = new Date();
  const timeStr = now.toTimeString().substr(0, 5);
  const onlineStatus = navigator.onLine ? 'ON' : 'OFF';
  
  document.querySelectorAll('[id$="-time"]').forEach(el => {
    el.textContent = `${timeStr} | ${onlineStatus} | --%`;
  });
}

function startClockUpdate() {
  updateClock();
  setInterval(updateClock, 60000);
}

function updateNetworkStatus() {
  const statusElement = document.getElementById('network-status');
  const syncDot = document.getElementById('sync-dot');
  
  if (navigator.onLine) {
    statusElement.textContent = 'Online';
    statusElement.className = 'success';
    syncDot.style.background = CONFIG.SYNC_QUEUE.length > 0 ? '#FF9900' : '#00CC33';
  } else {
    statusElement.textContent = 'Offline';
    statusElement.className = 'error';
    syncDot.style.background = '#CC0000';
  }
}

function updateSyncStatus() {
  const syncDot = document.getElementById('sync-dot');
  if (!syncDot) return;
  
  if (CONFIG.SYNC_QUEUE.length > 0) {
    syncDot.style.background = '#FF9900';
    syncDot.title = `${CONFIG.SYNC_QUEUE.length} pending sync`;
  } else if (!navigator.onLine) {
    syncDot.style.background = '#CC0000';
    syncDot.title = 'Offline';
  } else {
    syncDot.style.background = '#00CC33';
    syncDot.title = 'Synced';
  }
}

function showStatus(message, type) {
  const statusElement = document.getElementById('login-status');
  statusElement.textContent = message;
  statusElement.className = `status-text ${type}`;
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.className = `toast toast-${type}`;
  
  document.body.appendChild(toast);
  
  setTimeout(() => toast.style.opacity = '1', 10);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => {
      if (toast.parentNode) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

function saveToLocalStorage(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {
    console.error('LocalStorage save error:', e);
  }
}

function loadFromLocalStorage(key) {
  try {
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : null;
  } catch (e) {
    console.error('LocalStorage load error:', e);
    return null;
  }
}

function getStatusColor(status) {
  switch(status?.toUpperCase()) {
    case 'DELIVERED': return 'success';
    case 'SCANNED': return 'success';
    case 'EXCEPTION': return 'error';
    case 'PENDING': return 'warning';
    default: return '';
  }
}

async function updateStopStatus(stopId, status) {
  try {
    const result = await apiCall('updateStop', {
      stopId: stopId,
      status: status
    });
    
    if (result.success) {
      // Update local data
      const deliveries = loadFromLocalStorage('current_deliveries') || [];
      const stopIndex = deliveries.findIndex(s => s.stopId === stopId);
      if (stopIndex !== -1) {
        deliveries[stopIndex].status = status;
        saveToLocalStorage('current_deliveries', deliveries);
      }
    }
    
  } catch (error) {
    console.error('Update stop status error:', error);
  }
}

// ==============================================
// INITIALIZATION
// ==============================================
document.addEventListener('DOMContentLoaded', function() {
  // Load queued items
  CONFIG.SYNC_QUEUE = loadFromLocalStorage('sync_queue') || [];
  
  // Set up event listeners
  window.addEventListener('online', function() {
    updateNetworkStatus();
    processSyncQueue();
  });
  
  window.addEventListener('offline', updateNetworkStatus);
  
  // Initialize
  updateNetworkStatus();
  updateSyncStatus();
  
  // Auto-sync every 30 seconds
  setInterval(processSyncQueue, 30000);
  
  // Focus login input
  document.getElementById('courier-id-input').focus();
  
  // Check for saved courier ID
  const savedCourier = loadFromLocalStorage('current_courier');
  if (savedCourier && savedCourier.id) {
    document.getElementById('courier-id-input').value = savedCourier.id;
    // Auto-login can be enabled here if desired
  }
});

// Global helper
window.go = go;
</script>
</body>
</html>
