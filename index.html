<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Courier Handheld System</title>
  <meta name="viewport" content="width=240, height=320, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    /* BASE LAYOUT: 240x320 QVGA */
    html, body {
      margin: 0;
      padding: 0;
      width: 240px;
      height: 320px;
      background: #000;
      font-family: Arial, sans-serif;
      font-size: 11px;
      color: #FFFFFF;
      overflow: hidden;
    }

    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 240px;
      height: 320px;
      background: #101010;
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* HEADER (48px) */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      width: 240px;
      height: 48px;
      background: #F7C600;
      color: #000000;
      font-weight: bold;
    }

    .header-top-row {
      position: absolute;
      top: 2px;
      left: 4px;
      right: 4px;
      height: 16px;
      font-size: 10px;
    }

    .header-top-left {
      float: left;
    }

    .header-top-right {
      float: right;
    }

    .header-title {
      position: absolute;
      bottom: 4px;
      left: 4px;
      right: 4px;
      text-align: center;
      font-size: 13px;
    }

    /* FOOTER (42px) */
    .footer {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 240px;
      height: 42px;
      background: #303030;
      color: #FFFFFF;
      font-size: 10px;
    }

    .footer-left {
      position: absolute;
      left: 6px;
      top: 14px;
    }

    .footer-right {
      position: absolute;
      right: 6px;
      top: 14px;
      text-align: right;
    }

    .sync-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #00CC33;
      border-radius: 4px;
      margin-left: 4px;
    }

    /* CONTENT AREA (230px) */
    .content {
      position: absolute;
      top: 48px;
      left: 0;
      width: 240px;
      height: 230px;
      background: #101010;
      overflow: hidden;
    }

    /* MAIN MENU GRID */
    .menu-grid {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 224px;
      height: 214px;
    }

    .menu-button {
      position: absolute;
      width: 104px;
      height: 96px;
      background: #1A1A1A;
      border-radius: 6px;
      border: 1px solid #444444;
      text-align: center;
      color: #FFFFFF;
      cursor: pointer;
    }

    .menu-button:active {
      background: #2A2A2A;
      border-color: #F7C600;
    }

    .menu-button-title {
      position: absolute;
      bottom: 10px;
      left: 4px;
      right: 4px;
      font-size: 13px;
      font-weight: bold;
    }

    .menu-button-icon {
      position: absolute;
      top: 18px;
      left: 0;
      right: 0;
      font-size: 26px;
    }

    .btn-scan { top: 0; left: 0; }
    .btn-deliver { top: 0; left: 116px; }
    .btn-pickup { top: 104px; left: 0; }
    .btn-msg { top: 104px; left: 116px; }

    /* BUTTONS */
    .btn {
      background: #2A2A2A;
      border: 1px solid #555555;
      border-radius: 4px;
      color: #FFFFFF;
      padding: 4px 6px;
      font-size: 11px;
      cursor: pointer;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn:active:not(:disabled) {
      background: #3A3A3A;
    }

    .btn-primary {
      background: #F7C600;
      color: #000000;
      border-color: #C9A200;
      font-weight: bold;
    }

    .btn-primary:active {
      background: #D8B200;
    }

    .btn-block {
      display: block;
      width: 100%;
      text-align: center;
      box-sizing: border-box;
    }

    .btn-row {
      margin-top: 6px;
    }

    /* LISTS */
    .list {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      bottom: 4px;
      overflow-y: auto;
      border: 1px solid #333333;
      background: #181818;
    }

    .list-item {
      padding: 4px;
      border-bottom: 1px solid #333333;
      font-size: 11px;
      cursor: pointer;
    }

    .list-item:active {
      background: #2A2A2A;
    }

    .list-item-title {
      font-weight: bold;
      font-size: 12px;
    }

    .list-item-sub {
      font-size: 10px;
      color: #CCCCCC;
    }

    /* SCAN SCREEN */
    .scan-view {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      bottom: 40px;
      border: 1px solid #444444;
      background: #000000;
      text-align: center;
    }

    .scan-crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 120px;
      height: 60px;
      margin-left: -60px;
      margin-top: -30px;
      border: 1px dashed #555555;
    }

    .scan-label {
      position: absolute;
      bottom: 6px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      color: #888888;
    }

    .scan-buttons {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 4px;
      height: 32px;
      text-align: center;
    }

    .scan-buttons .btn {
      margin: 0 2px;
    }

    /* DELIVERY STOP */
    .stop-header {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      height: 52px;
      border: 1px solid #333333;
      background: #181818;
      padding: 4px;
      box-sizing: border-box;
      font-size: 11px;
      overflow-y: auto;
    }

    .stop-body {
      position: absolute;
      top: 60px;
      left: 4px;
      right: 4px;
      bottom: 4px;
    }

    .stop-buttons .btn {
      margin-bottom: 4px;
    }

    /* SIGNATURE SCREEN */
    .signature-pad {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      bottom: 40px;
      background: #FFFFFF;
      border: 1px solid #444444;
    }

    .signature-buttons {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 4px;
      text-align: center;
    }

    /* EXCEPTIONS */
    .exception-detail {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      bottom: 40px;
      border: 1px solid #333333;
      background: #181818;
      padding: 4px;
      box-sizing: border-box;
      font-size: 11px;
      overflow-y: auto;
    }

    .field-label {
      font-size: 10px;
      color: #CCCCCC;
      margin-top: 4px;
    }

    .field-input {
      width: 100%;
      box-sizing: border-box;
      font-size: 11px;
      padding: 2px;
      margin-top: 2px;
      background: #000000;
      color: #FFFFFF;
      border: 1px solid #555555;
    }

    .field-input:focus {
      border-color: #F7C600;
      outline: none;
    }

    textarea.field-input {
      resize: none;
      height: 60px;
    }

    /* LOGIN SCREEN */
    .login-container {
      position: absolute;
      top: 80px;
      left: 20px;
      right: 20px;
      text-align: center;
    }

    .login-input {
      width: 180px;
      height: 30px;
      font-size: 16px;
      text-align: center;
      margin-bottom: 10px;
      background: #000;
      color: #FFF;
      border: 1px solid #555;
    }

    .login-input:focus {
      border-color: #F7C600;
      outline: none;
    }

    /* STATUS & LOADING */
    .status-text {
      font-size: 10px;
      margin-top: 4px;
    }

    .loading {
      color: #F7C600;
    }

    .success {
      color: #00CC33;
    }

    .error {
      color: #CC0000;
    }

    .warning {
      color: #FF9900;
    }

    .hidden {
      display: none !important;
    }

    /* LOADING SPINNER */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #F7C600;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* TOAST NOTIFICATION */
    .toast {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 11px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .toast-success {
      background: #00CC33;
      color: white;
    }

    .toast-error {
      background: #CC0000;
      color: white;
    }

    .toast-warning {
      background: #FF9900;
      color: white;
    }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div id="screen-login" class="screen active">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left">Courier System</div>
        <div class="header-top-right">v1.0</div>
      </div>
      <div class="header-title">Login Required</div>
    </div>
    <div class="content">
      <div class="login-container">
        <div style="margin-bottom: 20px; font-size: 14px;">Enter Courier ID:</div>
        <input type="text" id="courier-id-input" class="login-input" value="" maxlength="10" placeholder="Enter ID" onkeypress="if(event.key==='Enter')performLogin()">
        <div class="btn-row">
          <button class="btn btn-primary btn-block" onclick="performLogin()" id="login-btn">LOGIN</button>
        </div>
        <div id="login-status" class="status-text"></div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left">Device: CS400</div>
      <div class="footer-right"><span id="network-status">Checking...</span></div>
    </div>
  </div>

  <!-- HOME SCREEN -->
  <div id="screen-home" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="home-time">--:-- | -- | --%</div>
        <div class="header-top-right" id="home-courier">ID: --</div>
      </div>
      <div class="header-title">Courier Menu</div>
    </div>
    <div class="content">
      <div class="menu-grid">
        <div class="menu-button btn-scan" onclick="goToScan()">
          <div class="menu-button-icon">▦</div>
          <div class="menu-button-title">SCAN</div>
        </div>
        <div class="menu-button btn-deliver" onclick="loadDeliveries()">
          <div class="menu-button-icon">◎</div>
          <div class="menu-button-title">DELIVERIES</div>
        </div>
        <div class="menu-button btn-pickup" onclick="loadPickups()">
          <div class="menu-button-icon">⬆</div>
          <div class="menu-button-title">PICKUPS</div>
        </div>
        <div class="menu-button btn-msg" onclick="loadMessages()">
          <div class="menu-button-icon">✉</div>
          <div class="menu-button-title">MESSAGES</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left">Route: <span id="route-info">--/--</span></div>
      <div class="footer-right">Sync <span class="sync-dot" id="sync-dot"></span></div>
    </div>
  </div>

  <!-- DELIVERIES LIST -->
  <div id="screen-deliveries" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="deliveries-time">--:-- | -- | --%</div>
        <div class="header-top-right" id="deliveries-route">Route: --/--</div>
      </div>
      <div class="header-title">Deliveries</div>
    </div>
    <div class="content">
      <div class="list" id="deliveries-list">
        <div class="list-item">
          <div class="list-item-title">Loading deliveries...</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-home')">◀ Menu</span></div>
      <div class="footer-right">Count: <span id="deliveries-count">--</span></div>
    </div>
  </div>

  <!-- DELIVERY STOP DETAIL -->
  <div id="screen-stop" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="stop-time">--:-- | -- | --%</div>
        <div class="header-top-right" id="stop-number">Stop --</div>
      </div>
      <div class="header-title" id="stop-name">--</div>
    </div>
    <div class="content">
      <div class="stop-header" id="stop-details">
        <div>Loading stop details...</div>
      </div>
      <div class="stop-body">
        <div class="stop-buttons">
          <div class="btn-row">
            <button class="btn btn-primary btn-block" onclick="goToScan()">Scan Package</button>
          </div>
          <div class="btn-row">
            <button class="btn btn-block" onclick="markAsDelivered()">Mark Delivered</button>
          </div>
          <div class="btn-row">
            <button class="btn btn-block" onclick="go('screen-exceptions')">Mark Exception</button>
          </div>
          <div class="btn-row">
            <button class="btn btn-block" onclick="showStopHistory()">View History</button>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-deliveries')">◀ Back</span></div>
      <div class="footer-right">Status: <span id="stop-status">--</span></div>
    </div>
  </div>

  <!-- SCAN SCREEN -->
  <div id="screen-scan" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="scan-time">--:-- | -- | --%</div>
        <div class="header-top-right">Scanner</div>
      </div>
      <div class="header-title">Scan Package</div>
    </div>
    <div class="content">
      <div class="scan-view">
        <div class="scan-crosshair"></div>
        <div class="scan-label">Align barcode within box</div>
        <div style="position: absolute; top: 10px; left: 0; right: 0; font-size: 10px; color: #F7C600;">
          Stop: <span id="current-stop-scan">--</span>
        </div>
      </div>
      <div class="scan-buttons">
        <button class="btn" onclick="manualBarcodeEntry()">Manual Entry</button>
        <button class="btn" onclick="clearLastScan()">Clear Last</button>
        <button class="btn" onclick="viewScanHistory()">History</button>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="goBackFromScan()">◀ Back</span></div>
      <div class="footer-right">Today: <span id="today-scans">0</span></div>
    </div>
  </div>

  <!-- EXCEPTIONS LIST -->
  <div id="screen-exceptions" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="exceptions-time">--:-- | -- | --%</div>
        <div class="header-top-right">Exceptions</div>
      </div>
      <div class="header-title">Select Exception</div>
    </div>
    <div class="content">
      <div class="list" id="exceptions-list">
        <div class="list-item">
          <div class="list-item-title">Loading exceptions...</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-stop')">◀ Stop</span></div>
      <div class="footer-right">Select</div>
    </div>
  </div>

  <!-- EXCEPTION DETAIL -->
  <div id="screen-exception-detail" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="exception-detail-time">--:-- | -- | --%</div>
        <div class="header-top-right">Exception</div>
      </div>
      <div class="header-title" id="exception-title">Exception</div>
    </div>
    <div class="content">
      <div class="exception-detail">
        <div class="field-label">Notes (Required)</div>
        <textarea class="field-input" id="exception-notes" rows="3" placeholder="Describe the issue..."></textarea>

        <div class="field-label">Action Taken</div>
        <select class="field-input" id="exception-action">
          <option value="">Select action...</option>
          <option value="LEFT_AT_DOOR">Left at door</option>
          <option value="LEFT_WITH_NEIGHBOR">Left with neighbor</option>
          <option value="RETURN_TO_DEPOT">Return to depot</option>
          <option value="RESCHEDULE">Reschedule delivery</option>
          <option value="OTHER">Other</option>
        </select>

        <div class="field-label">Attempted Contact</div>
        <select class="field-input" id="exception-contact">
          <option value="NONE">No contact</option>
          <option value="DOORBELL">Rang doorbell</option>
          <option value="PHONE_CALL">Phone call</option>
          <option value="SMS">SMS</option>
        </select>
      </div>
      <div class="signature-buttons">
        <button class="btn" onclick="go('screen-exceptions')">Cancel</button>
        <button class="btn btn-primary" onclick="saveException()">Save Exception</button>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-exceptions')">◀ Back</span></div>
      <div class="footer-right">Save</div>
    </div>
  </div>

  <!-- PICKUPS LIST -->
  <div id="screen-pickups" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="pickups-time">--:-- | -- | --%</div>
        <div class="header-top-right">Pickups</div>
      </div>
      <div class="header-title">Pickups</div>
    </div>
    <div class="content">
      <div class="list" id="pickups-list">
        <div class="list-item">
          <div class="list-item-title">Loading pickups...</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-home')">◀ Menu</span></div>
      <div class="footer-right">Count: <span id="pickups-count">--</span></div>
    </div>
  </div>

  <!-- SCAN HISTORY -->
  <div id="screen-scan-history" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="history-time">--:-- | -- | --%</div>
        <div class="header-top-right">History</div>
      </div>
      <div class="header-title">Scan History</div>
    </div>
    <div class="content">
      <div class="list" id="scan-history-list">
        <div class="list-item">
          <div class="list-item-title">Loading history...</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-scan')">◀ Scan</span></div>
      <div class="footer-right">Total: <span id="history-count">--</span></div>
    </div>
  </div>

  <!-- STOP HISTORY -->
  <div id="screen-stop-history" class="screen">
    <div class="header">
      <div class="header-top-row">
        <div class="header-top-left" id="stop-history-time">--:-- | -- | --%</div>
        <div class="header-top-right">History</div>
      </div>
      <div class="header-title">Stop History</div>
    </div>
    <div class="content">
      <div class="list" id="stop-history-list">
        <div class="list-item">
          <div class="list-item-title">Loading stop history...</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="footer-left"><span class="link" onclick="go('screen-stop')">◀ Stop</span></div>
      <div class="footer-right">Events: <span id="stop-history-count">--</span></div>
    </div>
  </div>

<script>
// ==============================================
// SIMPLIFIED WORKING VERSION
// ==============================================
const CONFIG = {
  API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxwMeFKiDmu5H1D62uMNMHXunFD6_rErktvDhKZXL4sKiJt6QyAcVtH5BcBzTRrZhsn/exec',
  COURIER_ID: null,
  CURRENT_ROUTE: null,
  CURRENT_STOP: null
};

// ==============================================
// SIMPLE API CALL
// ==============================================
async function apiCall(action, data = {}) {
  const params = new URLSearchParams();
  params.append('action', action);
  
  Object.keys(data).forEach(key => {
    if (data[key] !== null && data[key] !== undefined) {
      params.append(key, String(data[key]));
    }
  });
  
  const url = `${CONFIG.API_BASE_URL}?${params.toString()}`;
  console.log('API Calling:', url);
  
  try {
    const response = await fetch(url, { method: 'POST' });
    const result = await response.json();
    console.log('API Result:', result);
    return result;
  } catch (error) {
    console.error('API Error:', error);
    return { success: false, error: error.message };
  }
}

// ==============================================
// SIMPLE LOGIN
// ==============================================
async function performLogin() {
  const courierId = document.getElementById('courier-id-input').value.trim();
  if (!courierId) {
    showStatus('Please enter Courier ID', 'error');
    return;
  }
  
  const loginBtn = document.getElementById('login-btn');
  const statusElement = document.getElementById('login-status');
  
  loginBtn.disabled = true;
  loginBtn.textContent = 'LOGGING IN...';
  
  if (statusElement) {
    statusElement.textContent = 'Connecting...';
    statusElement.className = 'status-text loading';
  }
  
  try {
    // Try to login
    const result = await apiCall('login', { courierId: courierId });
    
    if (result.success) {
      CONFIG.COURIER_ID = courierId;
      
      if (statusElement) {
        statusElement.textContent = 'Login successful!';
        statusElement.className = 'status-text success';
      }
      
      // Update UI
      const homeCourierElement = document.getElementById('home-courier');
      if (homeCourierElement) {
        homeCourierElement.textContent = `ID: ${courierId}`;
      }
      
      // Go to home screen
      setTimeout(() => {
        go('screen-home');
        
        // Load routes
        loadTodayRoute();
        
      }, 1000);
      
    } else {
      throw new Error(result.message || 'Login failed');
    }
    
  } catch (error) {
    console.error('Login error:', error);
    
    if (statusElement) {
      statusElement.textContent = `Error: ${error.message}`;
      statusElement.className = 'status-text error';
    }
    
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'LOGIN';
  }
}

// ==============================================
// LOAD ROUTES
// ==============================================
async function loadTodayRoute() {
  if (!CONFIG.COURIER_ID) return;
  
  // Format today's date as DD-MM-YYYY
  const today = new Date();
  const day = String(today.getDate()).padStart(2, '0');
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const year = today.getFullYear();
  const todayFormatted = `${day}-${month}-${year}`;
  
  console.log('Loading route for date:', todayFormatted);
  
  try {
    const result = await apiCall('getRoutes', {
      courierId: CONFIG.COURIER_ID,
      date: todayFormatted
    });
    
    if (result.success && result.routes && result.routes.length > 0) {
      CONFIG.CURRENT_ROUTE = result.routes[0].routeId;
      
      // Update route info
      const routeInfoElement = document.getElementById('route-info');
      if (routeInfoElement) {
        const route = result.routes[0];
        routeInfoElement.textContent = `${route.completedStops || 0}/${route.totalStops || 0}`;
      }
      
      // Load stops for this route
      loadStopsForRoute(CONFIG.CURRENT_ROUTE);
      
    } else {
      console.log('No routes found:', result);
      showToast('No route for today', 'warning');
    }
    
  } catch (error) {
    console.error('Load route error:', error);
  }
}

// ==============================================
// LOAD STOPS
// ==============================================
async function loadStopsForRoute(routeId) {
  console.log('Loading stops for route:', routeId);
  
  try {
    const result = await apiCall('getStops', { routeId: routeId });
    
    if (result.success && result.stops) {
      console.log('Stops loaded:', result.stops.length);
      
      // Save stops to localStorage
      localStorage.setItem('current_stops', JSON.stringify(result.stops));
      
      // Filter deliveries
      const deliveries = result.stops.filter(stop => 
        stop.type && stop.type.toUpperCase() === 'DELIVERY'
      );
      
      // Update deliveries count
      const deliveriesCount = document.getElementById('deliveries-count');
      if (deliveriesCount) {
        deliveriesCount.textContent = deliveries.length;
      }
      
    } else {
      console.log('No stops found:', result);
    }
    
  } catch (error) {
    console.error('Load stops error:', error);
  }
}

// ==============================================
// LOAD DELIVERIES LIST
// ==============================================
async function loadDeliveries() {
  // First check if we have a route
  if (!CONFIG.CURRENT_ROUTE) {
    await loadTodayRoute();
  }
  
  go('screen-deliveries');
  
  try {
    // Try to load from localStorage first
    const stopsJson = localStorage.getItem('current_stops');
    let deliveries = [];
    
    if (stopsJson) {
      const allStops = JSON.parse(stopsJson);
      deliveries = allStops.filter(stop => 
        stop.type && stop.type.toUpperCase() === 'DELIVERY'
      );
    }
    
    // If no local data, try API
    if (deliveries.length === 0 && CONFIG.CURRENT_ROUTE) {
      const result = await apiCall('getStops', { routeId: CONFIG.CURRENT_ROUTE });
      if (result.success && result.stops) {
        deliveries = result.stops.filter(stop => 
          stop.type && stop.type.toUpperCase() === 'DELIVERY'
        );
        localStorage.setItem('current_stops', JSON.stringify(result.stops));
      }
    }
    
    // Display deliveries
    displayDeliveriesList(deliveries);
    
  } catch (error) {
    console.error('Load deliveries error:', error);
    showToast('Failed to load deliveries', 'error');
  }
}

function displayDeliveriesList(deliveries) {
  const listElement = document.getElementById('deliveries-list');
  const countElement = document.getElementById('deliveries-count');
  
  if (!listElement) return;
  
  if (!deliveries || deliveries.length === 0) {
    listElement.innerHTML = '<div class="list-item"><div class="list-item-title">No deliveries</div></div>';
    if (countElement) countElement.textContent = '0';
    return;
  }
  
  // Create HTML for each delivery
  let html = '';
  deliveries.forEach(stop => {
    html += `
      <div class="list-item" onclick="loadStopDetail('${stop.stopId}')">
        <div class="list-item-title">${stop.name || 'Unknown'}</div>
        <div class="list-item-sub">${stop.address || ''}, ${stop.city || ''}</div>
        <div class="list-item-sub">Parcels: ${stop.parcelCount || 1}</div>
      </div>
    `;
  });
  
  listElement.innerHTML = html;
  if (countElement) countElement.textContent = deliveries.length;
}

// ==============================================
// LOAD STOP DETAIL
// ==============================================
async function loadStopDetail(stopId) {
  CONFIG.CURRENT_STOP = stopId;
  
  try {
    // Get from localStorage first
    const stopsJson = localStorage.getItem('current_stops');
    let stop = null;
    
    if (stopsJson) {
      const allStops = JSON.parse(stopsJson);
      stop = allStops.find(s => s.stopId === stopId);
    }
    
    // If not found, try API
    if (!stop) {
      const result = await apiCall('getStop', { stopId: stopId });
      if (result.success && result.stop) {
        stop = result.stop;
      }
    }
    
    if (stop) {
      updateStopDetailScreen(stop);
      go('screen-stop');
    } else {
      showToast('Stop not found', 'error');
    }
    
  } catch (error) {
    console.error('Load stop error:', error);
    showToast('Failed to load stop', 'error');
  }
}

function updateStopDetailScreen(stop) {
  // Update all elements safely
  const elements = {
    'stop-name': stop.name || '--',
    'stop-number': `Stop ${stop.stopNumber || ''}`,
    'stop-status': stop.status || 'PENDING',
    'stop-parcels': stop.parcelCount || '--',
    'current-stop-scan': stop.name || '--'
  };
  
  Object.keys(elements).forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      if (id === 'stop-status') {
        element.textContent = elements[id];
        element.className = getStatusColor(elements[id]);
      } else {
        element.textContent = elements[id];
      }
    }
  });
  
  // Update stop details
  const stopDetails = document.getElementById('stop-details');
  if (stopDetails) {
    stopDetails.innerHTML = `
      <div><b>Address:</b> ${stop.address || ''}</div>
      <div>${stop.city || ''}, ${stop.zip || ''}</div>
      ${stop.phone ? `<div><b>Phone:</b> ${stop.phone}</div>` : ''}
      <div><b>Parcels:</b> ${stop.parcelCount || 1}</div>
    `;
  }
}

// ==============================================
// SCAN FUNCTIONS
// ==============================================
function goToScan() {
  if (!CONFIG.CURRENT_STOP) {
    showToast('Select a stop first', 'error');
    go('screen-deliveries');
    return;
  }
  
  // Remember current screen
  const activeScreen = document.querySelector('.screen.active');
  if (activeScreen && activeScreen.id) {
    CONFIG.LAST_SCREEN = activeScreen.id;
  }
  
  go('screen-scan');
}

async function manualBarcodeEntry() {
  const barcode = prompt('Enter barcode:');
  if (barcode && barcode.trim()) {
    await saveScan(barcode.trim());
  }
}

async function saveScan(barcode) {
  if (!CONFIG.CURRENT_STOP || !CONFIG.COURIER_ID) {
    showToast('No stop selected', 'error');
    return;
  }
  
  const scanData = {
    stopId: CONFIG.CURRENT_STOP,
    courierId: CONFIG.COURIER_ID,
    barcode: barcode,
    scanType: 'SCAN'
  };
  
  try {
    const result = await apiCall('saveScan', scanData);
    
    if (result.success) {
      showToast(`Scan saved: ${barcode}`, 'success');
      
      // Update scan count
      updateScanCount();
      
    } else {
      showToast(`Scan failed: ${result.message}`, 'error');
    }
    
  } catch (error) {
    console.error('Save scan error:', error);
    showToast('Scan failed', 'error');
  }
}

function updateScanCount() {
  const todayScans = document.getElementById('today-scans');
  if (todayScans) {
    const current = parseInt(todayScans.textContent) || 0;
    todayScans.textContent = current + 1;
  }
}

// ==============================================
// SIMPLE UI FUNCTIONS
// ==============================================
function go(screenId) {
  // Hide all screens
  document.querySelectorAll('.screen').forEach(screen => {
    screen.classList.remove('active');
  });
  
  // Show requested screen
  const screen = document.getElementById(screenId);
  if (screen) {
    screen.classList.add('active');
    
    // Update clock on screen change
    updateClock();
  }
}

function goBackFromScan() {
  go(CONFIG.LAST_SCREEN || 'screen-home');
}

function updateClock() {
  const now = new Date();
  const timeStr = now.toTimeString().substr(0, 5);
  const onlineStatus = navigator.onLine ? 'ON' : 'OFF';
  
  document.querySelectorAll('[id$="-time"]').forEach(el => {
    if (el) el.textContent = `${timeStr} | ${onlineStatus} | --%`;
  });
}

function updateNetworkStatus() {
  const statusElement = document.getElementById('network-status');
  const syncDot = document.getElementById('sync-dot');
  
  if (!statusElement || !syncDot) return;
  
  if (navigator.onLine) {
    statusElement.textContent = 'Online';
    statusElement.className = 'success';
    syncDot.style.background = '#00CC33';
  } else {
    statusElement.textContent = 'Offline';
    statusElement.className = 'error';
    syncDot.style.background = '#CC0000';
  }
}

function showStatus(message, type) {
  const statusElement = document.getElementById('login-status');
  if (statusElement) {
    statusElement.textContent = message;
    statusElement.className = `status-text ${type}`;
  }
}

function showToast(message, type = 'info') {
  // Create simple alert for now
  alert(`${type.toUpperCase()}: ${message}`);
}

function getStatusColor(status) {
  if (!status) return '';
  
  switch(status.toUpperCase()) {
    case 'DELIVERED': return 'success';
    case 'SCANNED': return 'success';
    case 'EXCEPTION': return 'error';
    case 'PENDING': return 'warning';
    default: return '';
  }
}

// ==============================================
// INITIALIZATION
// ==============================================
document.addEventListener('DOMContentLoaded', function() {
  // Set up network status
  updateNetworkStatus();
  window.addEventListener('online', updateNetworkStatus);
  window.addEventListener('offline', updateNetworkStatus);
  
  // Start clock
  updateClock();
  setInterval(updateClock, 60000);
  
  // Focus login input
  const loginInput = document.getElementById('courier-id-input');
  if (loginInput) {
    loginInput.focus();
    
    // Pre-fill with test ID
    loginInput.value = '48219';
  }
});

// Global helper
window.go = go;
</script>
</body>
</html>
